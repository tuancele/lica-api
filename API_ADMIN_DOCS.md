# API Admin Documentation

本文档记录所有 Admin API 端点的详细信息，按照 `.cursorrules` 规范维护。

---

## Product Management API

### 1. GET /admin/api/products

**Mục tiêu:** 获取产品列表，支持分页和过滤

**Tham số đầu vào (Query Params):**
- `page` (integer, optional): 页码，默认 1
- `limit` (integer, optional): 每页数量，默认 10
- `status` (string, optional): 状态过滤 (0=未激活, 1=激活)
- `cat_id` (integer, optional): 分类ID过滤
- `keyword` (string, optional): 关键词搜索（产品名称）
- `feature` (string, optional): 是否特色产品 (0/1)
- `best` (string, optional): 是否最佳产品 (0/1)

**Phản hồi mẫu (200):**
```json
{
  "success": true,
  "data": [
    {
      "id": 1,
      "name": "产品名称",
      "slug": "product-slug",
      "image": "https://example.com/image.jpg",
      "status": "1",
      "feature": "0",
      "best": "0",
      "stock": "1",
      "created_at": "2024-01-01T00:00:00.000000Z",
      "updated_at": "2024-01-01T00:00:00.000000Z"
    }
  ],
  "pagination": {
    "current_page": 1,
    "per_page": 10,
    "total": 100,
    "last_page": 10
  }
}
```

**Trạng thái:** Hoàn thành

---

## Warehouse Admin API (Realtime stock)

### 1. GET /admin/api/v1/warehouse/inventory

**Mục tiêu:** Lấy danh sách tồn kho realtime cho từng variant.

**Query Params:**
- `keyword` (string, optional): tìm theo tên sản phẩm / SKU
- `variant_id`, `product_id` (int, optional)
- `min_stock`, `max_stock` (int, optional) – lọc theo tồn khả dụng
- `sort_by` (`product_name`|`variant_name`|`stock`), `sort_order` (`asc`|`desc`)
- `limit` (int, 1–100, default 10)

**Logic tồn kho:**
- `physical_stock`: tồn kho vật lý (snapshot mới nhất từ `product_warehouse.physical_stock`; fallback `variants.stock` nếu chưa có snapshot). Chỉ tăng khi tạo phiếu nhập (Import Receipt) và không phụ thuộc việc xóa phiếu.
- `flash_sale_stock`: số lượng Flash Sale còn lại (SUM `number - buy` của Flash Sale đang active theo variant/product).
- `deal_stock`: số lượng Deal Sốc còn lại (SUM `qty - buy` của Deal đang active theo variant/product; `variant_id IS NULL` áp dụng ở cấp product).
- `available_stock`: `physical_stock - flash_sale_stock - deal_stock` (không âm).
- Response luôn kèm header `Cache-Control: no-store` để tránh cache.

**Phản hồi mẫu (200):**
```json
{
  "success": true,
  "data": [
    {
      "variant_id": 123,
      "variant_sku": "SKU-123",
      "variant_option": "Default",
      "product_id": 10,
      "product_name": "Sản phẩm A",
      "product_image": "https://cdn/...",
      "physical_stock": 120,
      "flash_sale_stock": 5,
      "deal_stock": 50,
      "available_stock": 65
    }
  ],
  "pagination": { "current_page": 1, "per_page": 20, "total": 200, "last_page": 10 }
}
```

**Trạng thái:** Hoàn thành

### 2. GET /admin/api/v1/warehouse/inventory/by-product/{productId}

**Mục tiêu:** Lấy tồn kho realtime cho từng variant của một sản phẩm (phục vụ chọn variant khi nhập/xuất).

**Phản hồi:** Mảng các variant với trường giống `inventory` ở trên: `physical_stock`, `flash_sale_stock`, `deal_stock`, `available_stock`.

**Trạng thái:** Hoàn thành

---

## Google Merchant Center (GMC) Admin API

### 1. GET /admin/api/gmc/products/preview

**Muc tieu:** Preview payload that would be sent to Google Merchant Center for one variant.

**Query Params:**
- `variant_id` (int, required)

**Phan hoi mau (200):**
```json
{
  "success": true,
  "data": {
    "offerId": "SKU-123",
    "title": "Product name",
    "availability": "in stock",
    "price": {"value": "120000", "currency": "VND"}
  }
}
```

**Trang thai:** Hoan thanh

---

## GoogleMerchant Module (Auto push to GMC)

### Overview
- Module path: `app/Modules/GoogleMerchant`
- Service: `app/Modules/GoogleMerchant/Services/GoogleMerchantService.php`
- Service account JSON: `storage/app/google/service-account.json` (must not be committed)
- Config: `config/gmc.php` -> `gmc.merchant_id` (env: `GMC_MERCHANT_ID`)

### Automation
- Product observer: `app/Modules/GoogleMerchant/Observers/ProductObserver.php`
- Variant observer: `app/Modules/GoogleMerchant/Observers/VariantObserver.php`
- Marketing Campaign observer: `app/Modules/Marketing/Observers/MarketingCampaignProductObserver.php` (auto-push when product added to Marketing Campaign)
- Jobs (queue):
  - `app/Modules/GoogleMerchant/Jobs/PushProductToGmcJob.php`
  - `app/Modules/GoogleMerchant/Jobs/PushVariantToGmcJob.php`

### Payload rules (current)
- offerId: **Stable per variant**, generated by `App\Services\Gmc\GmcOfferId` (default strategy: `sku`, fallback: `variant_id`). For truly simple products without variants: `PROD_{product_id}`.
- title: Product name; if Variant, append `color` / `size` names (example: `Base - Color - Size`)
- description: high quality text (name/brand/origin/variant + description/content + ingredients), strip HTML + html_entity_decode + normalize whitespace, min length enforced
- imageLink: absolute; if stored path (not http/https), prefix with `config('filesystems.disks.r2.url')`
- additionalImageLinks: up to 10 images from product gallery (absolute)
- brand: from product.brand.name, fallback `config('app.name')`
- googleProductCategory: optional from `GMC_GOOGLE_PRODUCT_CATEGORY`
- link: uses `GMC_STORE_BASE_URL` (fallback `APP_URL`) to avoid domain mismatch
- contentLanguage: `vi`
- targetCountry: `VN`
- feedLabel: `VN`
- availability: `in stock` if stock > 0 else `out of stock`
- price currency: `VND`
- price: **Original/base price** from product/variant (always sent, never promotional)
- salePrice: **Promotional price** (Priority: Flash Sale > Deal > Marketing Campaign)
- salePriceEffectiveDate: Date range from active promotion (format: `YYYY-MM-DDTHH:mm:ssZ/YYYY-MM-DDTHH:mm:ssZ`)
- itemGroupId: Product ID (for grouping variants)
- shippingWeight, productLength, productWidth, productHeight: Packaging dimensions (from product/variant, defaults: 100g, 10x10x10cm)

### Auto-push triggers
1. **Product/Variant saved**: Auto-push if `is_gmc_enabled` checkbox is checked
2. **Marketing Campaign**: Auto-push when product added to active Marketing Campaign (`MarketingCampaignProductObserver`)
3. **VARIABLE products**: Only push variants (not parent product) - enforced in all observers

**Status:** Completed

---

### 2. POST /admin/api/gmc/products/sync

**Muc tieu:** Sync one or more variants to GMC (insert).

**Body (JSON):**
- `variant_ids` (array<int>, required, min 1)
- `dry_run` (bool, optional)

**Phan hoi mau (200):**
```json
{
  "success": true,
  "data": {
    "dry_run": true,
    "results": [
      {"variant_id": 123, "success": true, "offer_id": "SKU-123", "sent": false}
    ]
  }
}
```

**Trang thai:** Hoan thanh

---

## Google Merchant Center Management Page

### GET /admin/google-merchant

**Muc tieu:** Trang quản lý danh sách sản phẩm GMC với trạng thái từ Google Merchant Center.

**Query Params:**
- `status` (string, optional): Lọc theo trạng thái (`all`, `approved`, `pending`, `disapproved`, `not_synced`)
- `keyword` (string, optional): Tìm kiếm theo tên sản phẩm

**Chức năng:**
- Hiển thị tất cả sản phẩm active với trạng thái GMC thực tế từ Google API
- Bộ lọc theo trạng thái: Đã duyệt, Chờ duyệt, Bị từ chối, Chưa đồng bộ
- Hiển thị chi tiết lỗi nếu sản phẩm bị Disapproved
- Nút "Đồng bộ ngay": Gọi API để push lại sản phẩm/variant lên GMC
- Nút "Làm mới trạng thái": Refresh trạng thái từ Google API

**Data Source:**
- Lấy trạng thái từ Google Merchant Center API (`productstatuses.get`)
- Hiển thị `dataQualityIssues` và `itemLevelIssues` nếu có

**Trang thai:** Hoan thanh

### POST /admin/google-merchant/sync

**Muc tieu:** Đồng bộ sản phẩm/variant lên GMC ngay lập tức.

**Body (JSON):**
- `product_id` (int, optional): ID sản phẩm (cho sản phẩm đơn)
- `variant_id` (int, optional): ID variant (cho sản phẩm có biến thể)

**Phan hoi mau (200):**
```json
{
  "success": true,
  "message": "Variant sync queued successfully",
  "variant_id": 123
}
```

**Trang thai:** Hoan thanh

### GET /admin/google-merchant/status

**Muc tieu:** Lấy trạng thái GMC cho sản phẩm/variant.

**Query Params:**
- `product_id` (int, optional): ID sản phẩm
- `variant_id` (int, optional): ID variant

**Phan hoi mau (200):**
```json
{
  "success": true,
  "data": {
    "offer_id": "SKU-123",
    "status": {
      "status": "approved",
      "issues": [],
      "destination_statuses": []
    }
  }
}
```

**Trang thai:** Hoan thanh

---

## Ingredient Dictionary Admin API

### 1. GET /admin/api/ingredients

**Mục tiêu:** Lấy danh sách thành phần (IngredientPaulas) với phân trang và bộ lọc.

**Tham số đầu vào (Query Params):**
- `page` (int, optional): trang, mặc định 1
- `limit` (int, optional): số bản ghi, mặc định 20, tối đa 100
- `keyword` (string, optional): tìm theo name
- `status` (int, optional): 0/1
- `rate_id` (int, optional)
- `cat_id` (array|int, optional): id danh mục
- `benefit_id` (array|int, optional): id lợi ích

**Phản hồi mẫu (200):**
```json
{
  "success": true,
  "data": [
    {
      "id": 1,
      "name": "AHA",
      "slug": "ingredient-aha",
      "status": "1",
      "rate": {"id": 2,"name": "BEST"},
      "categories": [{"id": 1,"name": "Acid"}],
      "benefits": [{"id": 3,"name": "Brightening"}],
      "seo_title": "AHA",
      "seo_description": "Acid tẩy tế bào chết"
    }
  ],
  "pagination": {"current_page":1,"per_page":20,"total":100,"last_page":5}
}
```

**Trạng thái:** Hoàn thành

---

### 2. POST /admin/api/ingredients

**Mục tiêu:** Tạo thành phần mới (slug duy nhất).

**Body (JSON):**
- `name` (string, required, 1-250)
- `slug` (string, required, unique)
- `status` (int, required, 0/1)
- `rate_id` (int, optional, exists:ingredient_rate,id)
- `cat_id` (array<int>, optional, exists:ingredient_category,id)
- `benefit_id` (array<int>, optional, exists:ingredient_benefit,id)
- `description`, `content`, `glance`, `reference`, `disclaimer`, `seo_title`, `seo_description`, `shortcode` (optional)

**Phản hồi mẫu (201):**
```json
{
  "success": true,
  "message": "创建成分成功",
  "data": {"id": 10, "name": "Niacinamide", "slug": "niacinamide"}
}
```

**Trạng thái:** Hoàn thành

---

### 3. PUT /admin/api/ingredients/{id}

**Mục tiêu:** Cập nhật thành phần (slug unique ignore id).

**Body:** giống POST.

**Phản hồi mẫu (200):**
```json
{
  "success": true,
  "message": "更新成分成功",
  "data": {"id": 10, "name": "Niacinamide 10%", "slug": "niacinamide"}
}
```

**Trạng thái:** Hoàn thành

---

### 4. DELETE /admin/api/ingredients/{id}

**Mục tiêu:** Xóa thành phần.

**Phản hồi mẫu (200):**
```json
{"success": true, "message": "删除成分成功"}
```

**Trạng thái:** Hoàn thành

---

### 5. PATCH /admin/api/ingredients/{id}/status

**Mục tiêu:** Đổi trạng thái 0/1.

**Body:** `status` (required, 0/1)

**Phản hồi mẫu (200):**
```json
{"success": true, "message": "状态更新成功", "data": {"id": 10, "status": "1"}}
```

**Trạng thái:** Hoàn thành

---

### 6. POST /admin/api/ingredients/bulk-action

**Mục tiêu:** Bulk action 0=hide,1=show,2=delete (giữ nguyên logic cũ).

**Body:** `checklist` (array<int>, required), `action` (int, required, in:0,1,2)

**Phản hồi mẫu (200):**
```json
{"success": true, "message": "批量操作成功"}
```

**Trạng thái:** Hoàn thành

---

### 7. GET /admin/api/ingredients/crawl/summary

**Mục tiêu:** Lấy tổng số bản ghi & số trang crawl từ Paula’s Choice.

**Phản hồi mẫu (200):**
```json
{"success": true, "data": {"total": 5400, "pages": 3}}
```

**Trạng thái:** Hoàn thành

---

### 8. POST /admin/api/ingredients/crawl/run

**Mục tiêu:** Chạy crawl theo `offset`, an toàn timeout, `set_time_limit(0)` và ghi log lỗi.

**Body:** `offset` (int, required, min:0)

**Phản hồi mẫu (200):**
```json
{"success": true, "message": "AHA - updated\nBHA - created"}
```

**Trạng thái:** Hoàn thành

---

## Public Dictionary API

### 1. GET /api/dictionary/ingredients

**Muc tieu:** Public list ingredients for scanning (title + slug only), order by title length DESC.

**Query Params:** none

**Phan hoi mau (200):**
```json
{
  "success": true,
  "data": [
    {"title": "Acetyl sh-Hexapeptide-5 Amide Acetate", "slug": "ingredient-acetyl-sh-hexapeptide-5-amide-acetate"},
    {"title": "AHA", "slug": "ingredient-aha"}
  ]
}
```

**Trang thai:** Hoan thanh

---

### 9. Ingredient Category / Benefit / Rate APIs

- `GET /admin/api/ingredient-categories` (benefits, rates tương tự) – danh sách + phân trang.
- `POST /admin/api/ingredient-categories` – tạo (name required, status 0/1, sort optional).
- `PUT /admin/api/ingredient-categories/{id}` – cập nhật.
- `DELETE /admin/api/ingredient-categories/{id}` – xóa.
- `PATCH /admin/api/ingredient-categories/{id}/status` – đổi trạng thái.
- `POST /admin/api/ingredient-categories/bulk-action` – action 0/1/2.

**Phản hồi mẫu (200):**
```json
{
  "success": true,
  "message": "创建成功",
  "data": {"id": 1, "name": "Acid", "status": "1", "sort": 0}
}
```

**Trạng thái:** Hoàn thành

---

### 11. Product Taxonomy (Danh muc san pham) APIs

- `GET /admin/api/taxonomies` – danh sách danh mục sản phẩm (taxonomy) + phân trang + bộ lọc.
- `GET /admin/api/taxonomies/{id}` – chi tiết một danh mục.
- `POST /admin/api/taxonomies` – tạo danh mục mới.
- `PUT /admin/api/taxonomies/{id}` – cập nhật danh mục.
- `DELETE /admin/api/taxonomies/{id}` – xóa danh mục (chỉ khi không có danh mục con).
- `PATCH /admin/api/taxonomies/{id}/status` – đổi trạng thái 0/1.
- `POST /admin/api/taxonomies/bulk-action` – bulk 0=hide,1=show,2=delete.
- `PATCH /admin/api/taxonomies/sort` – cập nhật cây phân cấp + thứ tự sắp xếp.

**1. GET /admin/api/taxonomies**

**Muc tieu:** Lấy danh sách danh mục sản phẩm (`posts.type = taxonomy`) với phân trang.

**Query Params:**
- `page` (int, optional): trang, mặc định 1
- `limit` (int, optional): số bản ghi/trang, mặc định 20, tối đa 100
- `status` (int, optional): 0/1
- `keyword` (string, optional): tìm theo tên
- `parent_id` (int, optional): lọc theo danh mục cha (`cat_id`)
- `is_home` (int, optional): 0/1
- `feature` (int, optional): 0/1

**Phan hoi mau (200):**
```json
{
  "success": true,
  "data": [
    {
      "id": 1,
      "name": "Sua rua mat",
      "slug": "sua-rua-mat",
      "image": "https://cdn.lica.vn/uploads/categories/srm.jpg",
      "status": 1,
      "feature": 1,
      "is_home": 1,
      "tracking": "",
      "parent_id": 0,
      "sort": 0,
      "seo_title": "Sua rua mat",
      "seo_description": "Danh muc sua rua mat",
      "created_at": "2026-01-20T10:00:00.000000Z",
      "updated_at": "2026-01-20T10:00:00.000000Z"
    }
  ],
  "pagination": {
    "current_page": 1,
    "per_page": 20,
    "total": 5,
    "last_page": 1
  }
}
```

**2. GET /admin/api/taxonomies/{id}**

**Muc tieu:** Lấy chi tiết một danh mục sản phẩm.

**Phan hoi mau (200):**
```json
{
  "success": true,
  "data": {
    "id": 1,
    "name": "Sua rua mat",
    "slug": "sua-rua-mat",
    "image": "https://cdn.lica.vn/uploads/categories/srm.jpg",
    "status": 1,
    "feature": 1,
    "is_home": 1,
    "tracking": "",
    "parent_id": 0,
    "sort": 0,
    "seo_title": "Sua rua mat",
    "seo_description": "Danh muc sua rua mat",
    "created_at": "2026-01-20T10:00:00.000000Z",
    "updated_at": "2026-01-20T10:00:00.000000Z"
  }
}
```

**3. POST /admin/api/taxonomies**

**Muc tieu:** Tao danh muc san pham moi.

**Body (JSON):**
- `name` (string, required, 1-250)
- `slug` (string, required, unique:posts,slug)
- `image` (string, optional, max 500)
- `content` (string, optional)
- `status` (int, required, in:0,1)
- `feature` (int, optional, in:0,1)
- `is_home` (int, optional, in:0,1)
- `tracking` (string, optional, max 500)
- `cat_id` (int, optional) – id danh mục cha
- `seo_title` (string, optional, max 250)
- `seo_description` (string, optional, max 500)

**Phan hoi mau (201):**
```json
{
  "success": true,
  "message": "Tao danh muc thanh cong",
  "data": {
    "id": 10,
    "name": "Toner",
    "slug": "toner",
    "status": 1,
    "parent_id": 1
  }
}
```

**4. PUT /admin/api/taxonomies/{id}**

**Muc tieu:** Cap nhat danh muc san pham.

**Body:** giong POST, `slug` unique ignore id.

**Phan hoi mau (200):**
```json
{
  "success": true,
  "message": "Cap nhat danh muc thanh cong",
  "data": {
    "id": 10,
    "name": "Toner cap am",
    "slug": "toner",
    "status": 1
  }
}
```

**5. DELETE /admin/api/taxonomies/{id}**

**Muc tieu:** Xoa danh muc (chi khi khong co danh muc con).

**Phan hoi mau (200):**
```json
{
  "success": true,
  "message": "Xoa danh muc thanh cong"
}
```

**Phan hoi loi (400 – co danh muc con):**
```json
{
  "success": false,
  "message": "Danh muc chua danh muc con, khong the xoa"
}
```

**6. PATCH /admin/api/taxonomies/{id}/status**

**Muc tieu:** Cap nhat trang thai 0/1.

**Body (JSON):**
- `status` (int, required, in:0,1)

**Phan hoi mau (200):**
```json
{
  "success": true,
  "message": "Cap nhat trang thai thanh cong",
  "data": {
    "id": 10,
    "status": 1
  }
}
```

**7. POST /admin/api/taxonomies/bulk-action**

**Muc tieu:** Bulk action danh muc.

**Body (JSON):**
- `checklist` (array<int>, required): danh sach id danh muc
- `action` (int, required, in:0,1,2): 0=hide,1=show,2=delete

**Note:**
- Khi `action=2`, cac danh muc co danh muc con se bi bo qua (khong xoa), de an toan.

**Phan hoi mau (200):**
```json
{
  "success": true,
  "message": "Bulk action danh muc thanh cong"
}
```

**8. PATCH /admin/api/taxonomies/sort**

**Muc tieu:** Cap nhat cay danh muc va thu tu sap xep.

**Body (JSON):**
```json
{
  "items": [
    { "id": 1, "parent_id": 0, "sort": 0 },
    { "id": 2, "parent_id": 1, "sort": 1 }
  ]
}
```

**Phan hoi mau (200):**
```json
{
  "success": true,
  "message": "Cap nhat sap xep danh muc thanh cong"
}
```

**Trang thai:** Hoan thanh

---

### 10. GET /api/admin/dictionary/all-ingredients

**Muc tieu:** Return all items from `ingredient_paulas` with benefits and rates. Sort by title length DESC.

**Tham so dau vao:** None

**Phan hoi mau (200):**
```json
{
  "success": true,
  "data": [
    {
      "title": "Sodium Hyaluronate Crosspolymer",
      "slug": "ingredient-sodium-hyaluronate-crosspolymer",
      "benefits": [
        { "id": 1, "name": "Hydration" }
      ],
      "rates": [
        { "id": 2, "name": "Dry Skin" }
      ]
    }
  ]
}
```

**Trang thai:** Hoan thanh

---

### 2. GET /admin/api/products/{id}

**Mục tiêu:** 获取单个产品详情（包含关联数据：品牌、产地、分类、变体等），chuẩn hóa dữ liệu cho trang Edit sản phẩm (Admin).

**Tham số đầu vào (Path Params):**
- `id` (integer, required): 产品ID（URL参数）

**Trường dữ liệu chính trong `data`:**
- `id` (int) – Product ID
- `name` (string) – Tên sản phẩm
- `slug` (string) – Đường dẫn chuẩn SEO
- `video` (string|null) – URL video sản phẩm
- `image` (string|null) – Ảnh chính
- `gallery` (string[]) – Danh sách URL ảnh (được map vào `imageOther[]` ở form)
- `content` (string) – Nội dung chi tiết (HTML)
- `description` (string|null) – Mô tả ngắn
- `cbmp` (string|null) – Mã CBMP
- `status` (int) – 状态 0/1
- `feature`, `best`, `verified` (string "0"/"1") – Cờ đánh dấu
- `stock` (string|int) – Cờ stock cũ
- `warehouse_stock` (int) – Tổng tồn kho thực tế
- `is_out_of_stock` (bool) – Hết hàng hay chưa
- `sort` (int) – Thứ tự sắp xếp
- `has_variants` (int 0/1) – Có phân loại hay không
- `option1_name` (string|null) – Tên nhóm phân loại (ví dụ "Dung tich")
- `ingredient` (string|null) – Chuỗi thành phần
- `brand_id`, `origin_id` (int|null) – ID Thương hiệu / Xuất xứ
- `brand`, `origin` (object|null) – Thông tin chi tiết brand/origin
- `categories` (int[]) – Mảng ID danh mục (leaf ở cuối), map vào `cat_id[]` ở form
- `variants` (array<object>) – Danh sách biến thể; mỗi phần tử:
  - `id`, `product_id`
  - `sku`
  - `option1_value`
  - `image`
  - `size_id`, `color_id`
  - `weight` (float)
  - `price` (float)
  - `stock` (int)
  - `warehouse_stock` (int)
  - `is_out_of_stock` (bool)
  - `position` (int)
- `seo_title`, `seo_description` (string|null)
- `created_at`, `updated_at` (ISO 8601 string)

**Phản hồi mẫu (200):**
```json
{
  "success": true,
  "data": {
    "id": 1,
    "name": "San pham A",
    "slug": "san-pham-a",
    "video": "https://cdn.lica.vn/videos/sp-a.mp4",
    "image": "https://cdn.lica.vn/uploads/products/sp-a-main.jpg",
    "gallery": [
      "https://cdn.lica.vn/uploads/products/sp-a-main.jpg",
      "https://cdn.lica.vn/uploads/products/sp-a-2.jpg"
    ],
    "content": "<p>Noi dung chi tiet HTML...</p>",
    "description": "Mo ta ngan san pham",
    "cbmp": "123/CBMP-XY-2024",
    "status": 1,
    "feature": "0",
    "best": "0",
    "stock": "1",
    "warehouse_stock": 120,
    "is_out_of_stock": false,
    "verified": "1",
    "sort": 0,
    "has_variants": 1,
    "option1_name": "Dung tich",
    "ingredient": "Water, Niacinamide...",
    "brand_id": 5,
    "origin_id": 2,
    "brand": {
      "id": 5,
      "name": "Brand X",
      "slug": "brand-x"
    },
    "origin": {
      "id": 2,
      "name": "Korea",
      "slug": "korea"
    },
    "categories": [1, 10, 25],
    "variants": [
      {
        "id": 1,
        "sku": "SKU-001-30ML",
        "product_id": 1,
        "option1_value": "30ml",
        "image": "https://cdn.lica.vn/uploads/products/sp-a-main.jpg",
        "size_id": null,
        "color_id": null,
        "weight": 0.2,
        "price": 250000,
        "stock": 100,
        "warehouse_stock": 100,
        "is_out_of_stock": false,
        "position": 1
      }
    ],
    "seo_title": "San pham A - Title",
    "seo_description": "Mo ta SEO ngan",
    "created_at": "2024-01-01T00:00:00.000000Z",
    "updated_at": "2024-05-01T00:00:00.000000Z"
  }
}
```

**Trạng thái:** Hoàn thành

---

## Order Admin API

### 1. GET /admin/api/orders

**Mục tiêu:** Lấy danh sách đơn hàng cho Admin với phân trang và bộ lọc cơ bản.

**Tham số đầu vào (Query Params):**
- `page` (int, optional): trang, mặc định 1
- `limit` (int, optional): số bản ghi/trang, mặc định 10, tối đa 100
- `status` (string, optional): trạng thái đơn (`0,1,2,3,4`)
- `ship` (string, optional): trạng thái giao hàng
- `code` (string, optional): mã đơn hàng
- `keyword` (string, optional): tìm theo `code/name/phone`

**Phản hồi mẫu (200):**
```json
{
  "success": true,
  "data": [
    {
      "id": 1,
      "code": "LICA-20260101-0001",
      "name": "Nguyen Van A",
      "phone": "0900000000",
      "status": "1",
      "payment": "1",
      "ship": "0",
      "total": 1500000,
      "sale": 100000,
      "created_at": "2026-01-20T10:00:00.000000Z",
      "province": {"id": 1, "name": "Hà Nội"},
      "district": {"id": 2, "name": "Cầu Giấy"},
      "ward": {"id": 3, "name": "Dịch Vọng"},
      "member": {"id": 10, "name": "Nguyen Van A"}
    }
  ],
  "pagination": {
    "current_page": 1,
    "per_page": 10,
    "total": 120,
    "last_page": 12
  }
}
```

**Trạng thái:** Hoàn thành

---

### 2. GET /admin/api/orders/{id}

**Mục tiêu:** Lấy chi tiết một đơn hàng (bao gồm line items).

**Phản hồi mẫu (200):**
```json
{
  "success": true,
  "data": {
    "id": 1,
    "code": "LICA-20260101-0001",
    "name": "Nguyen Van A",
    "phone": "0900000000",
    "status": "1",
    "payment": "1",
    "ship": "0",
    "total": 1500000,
    "sale": 100000,
    "address": "Số 1 Đường ABC",
    "province": {"id": 1, "name": "Hà Nội"},
    "district": {"id": 2, "name": "Cầu Giấy"},
    "ward": {"id": 3, "name": "Dịch Vọng"},
    "member": {"id": 10, "name": "Nguyen Van A"},
    "items": [
      {
        "product_id": 100,
        "variant_id": 200,
        "name": "Sữa rửa mặt A",
        "sku": "SRM-A-100",
        "qty": 2,
        "price": 500000,
        "subtotal": 1000000
      }
    ]
  }
}
```

**Trạng thái:** Hoàn thành

---

### 3. PATCH /admin/api/orders/{id}/status

**Mục tiêu:** Cập nhật nhanh trạng thái đơn hàng (status/payment/ship, content).

**Body (JSON):**
- `status` (string, required, one of: `0,1,2,3,4`)
- `payment` (string, optional, one of: `0,1,2`)
- `ship` (string, optional, one of: `0,1,2,3,4`)
- `content` (string, optional)

**Phản hồi mẫu (200):**
```json
{
  "success": true,
  "message": "Cập nhật trạng thái thành công",
  "data": {
    "id": 1,
    "status": "4",
    "payment": "1",
    "ship": "3"
  }
}
```

**Trạng thái:** Hoàn thành

---

## Warehouse V2 Admin / API

### 1. GET /api/v2/inventory/warehouses

**Mục tiêu:** Lấy danh sách kho V2 đang active, phục vụ chọn kho trong màn hình tồn kho/phiếu nhập/xuất.

**Phản hồi mẫu (200):**
```json
{
  "success": true,
  "data": [
    {
      "id": 1,
      "code": "MAIN",
      "name": "Kho trung tâm",
      "address": "Số 1, Đường ABC, Quận XYZ",
      "is_active": true,
      "is_default": true
    }
  ]
}
```

**Ghi chú:** Từ Phase 2, danh sách kho được lấy qua `WarehouseV2Service` + `WarehouseRepository`, không truy vấn thẳng `WarehouseV2` trong controller.

**Trạng thái:** Hoàn thành

---

### 3. POST /admin/api/products

**Mục tiêu:** 创建新产品

**Tham số đầu vào (Body - JSON):**
- `name` (string, required): 产品名称，1-250字符
- `slug` (string, required): URL友好标识，唯一，格式：小写字母、数字、连字符
- `content` (string, optional): 产品详细内容
- `description` (string, optional): 产品描述，最大500字符
- `video` (string, optional): 视频URL，最大500字符
- `imageOther` (array, optional): 图片URL数组
- `cat_id` (array, optional): 分类ID数组
- `brand_id` (integer, optional): 品牌ID
- `origin_id` (integer, optional): 产地ID
- `ingredient` (string, optional): 成分（文本，系统会自动链接到成分字典）
- `price` (numeric, optional): 价格（无变体模式）
- `sale` (numeric, optional): 促销价（无变体模式）
- `stock_qty` (integer, optional): 库存数量（无变体模式）
- `weight` (numeric, optional): 重量（无变体模式）
- `sku` (string, optional): SKU（无变体模式），最大100字符，必须唯一
- `has_variants` (integer, optional): 是否有变体 (0/1)，默认0
- `option1_name` (string, optional): 变体选项名称（当has_variants=1时必填），最大50字符
- `variants_json` (string, optional): 变体JSON数据（当has_variants=1时必填）
- `status` (integer, optional): 状态 (0/1)，默认1
- `feature` (integer, optional): 是否特色 (0/1)，默认0
- `best` (integer, optional): 是否最佳 (0/1)，默认0
- `stock` (integer, optional): 是否有库存 (0/1)，默认1
- `seo_title` (string, optional): SEO标题，最大250字符
- `seo_description` (string, optional): SEO描述，最大500字符
- `r2_session_key` (string, optional): R2上传会话密钥

**Logic tự động:**
- Nếu `stock_qty` > 0 (sản phẩm không có variants) hoặc variants có `stock` > 0, hệ thống sẽ tự động tạo phiếu nhập hàng trong kho hàng với:
  - Mã phiếu: `NH-PRODUCT-{product_id}-{timestamp}`
  - Tiêu đề: "Nhập hàng ban đầu cho sản phẩm: {product_name}"
  - Nội dung: "Tự động tạo phiếu nhập hàng khi tạo sản phẩm mới"
  - Giá nhập: Sử dụng giá từ variant (price)
  - Số lượng: Sử dụng stock_qty hoặc stock từ variants
  - VAT Invoice: Để trống

**Phản hồi mẫu (201):**
```json
{
  "success": true,
  "message": "产品创建成功",
  "data": {
    "id": 1,
    "name": "产品名称",
    "slug": "product-slug"
  }
}
```

**Trạng thái:** Hoàn thành

---

### 4. PUT /admin/api/products/{id}

**Mục tiêu:** 更新现有产品（包括基本信息、SEO、hình ảnh, danh mục, thương hiệu/xuất xứ, phân loại và tồn kho ban đầu），được dùng làm kênh lưu chính cho trang Edit sản phẩm Admin.

**Tham số đầu vào:**
- `id` (integer, required, Path): 产品ID（URL参数）

**Body (JSON) – các trường quan trọng:**
- `name` (string, required, 1-250) – Tên sản phẩm
- `slug` (string, required, unique:posts,slug,{id}, regex: `^[a-z0-9]+(?:-[a-z0-9]+)*$`)
- `content` (string, optional) – Nội dung chi tiết (HTML)
- `description` (string, optional, max:500) – Mô tả ngắn
- `video` (string, optional, url, max:500) – URL video sản phẩm
- `imageOther` (string[], optional) – Danh sách URL ảnh hiện tại (theo thứ tự mới)
- `imageOtherRemoved` (string[], optional) – Danh sách URL ảnh cần xóa
- `cat_id` (int[], optional) – Mảng ID danh mục (leaf ở cuối là danh mục trực tiếp)
- `brand_id` (int, optional, exists:brands,id) – ID thương hiệu
- `origin_id` (int, optional, exists:origins,id) – ID xuất xứ
- `ingredient` (string, optional) – Chuỗi thành phần
- `cbmp` (string, optional, max:250) – Mã CBMP
- `price` (numeric, optional, min:0) – Giá bán (single mode)
- `stock_qty` (int, optional, min:0) – Tồn kho ban đầu (single mode)
- `weight` (numeric, optional, min:0) – Trọng lượng (single mode)
- `sku` (string, optional, max:100) – SKU (single mode, unique sẽ được service xử lý)
- `has_variants` (int|string, optional, in:0,1) – 1 = dùng phân loại, 0 = single
- `option1_name` (string, required_if:has_variants,1, max:50) – Tên nhóm phân loại
- `variants_json` (string, required_if:has_variants,1) – JSON phân loại (Shopee-style), backend sẽ parse và đồng bộ bảng `variants`
- `status` (int, optional, in:0,1)
- `feature` (int, optional, in:0,1)
- `best` (int, optional, in:0,1)
- `stock` (int, optional, in:0,1) – Cờ có tồn hay không (giữ logic cũ)
- `seo_title` (string, optional, max:250)
- `seo_description` (string, optional, max:500)
- `r2_session_key` (string, optional) – Khóa session upload R2 để backend dọn dẹp URL tạm

> Ghi chú: Form FE gửi thêm `_token` (CSRF) và `_method` (nếu dùng), nhưng API chuẩn sử dụng `PUT` thuần với JSON body như trên.

**Phản hồi mẫu (200):**
```json
{
  "success": true,
  "message": "产品更新成功",
  "data": {
    "id": 1,
    "name": "San pham A (updated)",
    "slug": "san-pham-a",
    "video": "https://cdn.lica.vn/videos/sp-a.mp4",
    "image": "https://cdn.lica.vn/uploads/products/sp-a-main.jpg",
    "gallery": [
      "https://cdn.lica.vn/uploads/products/sp-a-main.jpg",
      "https://cdn.lica.vn/uploads/products/sp-a-2.jpg"
    ],
    "content": "<p>Noi dung chi tiet sau khi cap nhat...</p>",
    "description": "Mo ta ngan sau khi cap nhat",
    "cbmp": "123/CBMP-XY-2024",
    "status": 1,
    "feature": "0",
    "best": "0",
    "stock": "1",
    "warehouse_stock": 120,
    "is_out_of_stock": false,
    "verified": "1",
    "sort": 0,
    "has_variants": 1,
    "option1_name": "Dung tich",
    "ingredient": "Water, Niacinamide...",
    "brand_id": 5,
    "origin_id": 2,
    "brand": {
      "id": 5,
      "name": "Brand X",
      "slug": "brand-x"
    },
    "origin": {
      "id": 2,
      "name": "Korea",
      "slug": "korea"
    },
    "categories": [1, 10, 25],
    "variants": [
      {
        "id": 1,
        "sku": "SKU-001-30ML",
        "product_id": 1,
        "option1_value": "30ml",
        "image": "https://cdn.lica.vn/uploads/products/sp-a-main.jpg",
        "size_id": null,
        "color_id": null,
        "weight": 0.2,
        "price": 250000,
        "stock": 100,
        "warehouse_stock": 100,
        "is_out_of_stock": false,
        "position": 1
      }
    ],
    "seo_title": "San pham A - Title",
    "seo_description": "Mo ta SEO ngan",
    "created_at": "2024-01-01T00:00:00.000000Z",
    "updated_at": "2024-06-01T00:00:00.000000Z"
  }
}
```

**Trạng thái:** Hoàn thành

---

### 5. DELETE /admin/api/products/{id}

**Mục tiêu:** 删除产品（如果产品已有订单则不允许删除）

**Tham số đầu vào:**
- `id` (integer, required): 产品ID（URL参数）

**Phản hồi mẫu (200):**
```json
{
  "success": true,
  "message": "产品删除成功"
}
```

**Phản hồi lỗi (400):**
```json
{
  "success": false,
  "message": "Không thể xóa sản phẩm đã có đơn hàng"
}
```

**Trạng thái:** Hoàn thành

---

### 6. PATCH /admin/api/products/{id}/status

**Mục tiêu:** 更新产品状态（激活/未激活）

**Tham số đầu vào:**
- `id` (integer, required): 产品ID（URL参数）
- `status` (integer, required): 状态值 (0=未激活, 1=激活)

**Phản hồi mẫu (200):**
```json
{
  "success": true,
  "message": "状态更新成功",
  "data": {
    "id": 1,
    "status": "1"
  }
}
```

**Trạng thái:** Hoàn thành

---

### 7. POST /admin/api/products/bulk-action

**Mục tiêu:** 批量操作产品（批量更新状态、批量删除）

**Tham số đầu vào (Body - JSON):**
- `checklist` (array, required): 产品ID数组
- `action` (integer, required): 操作类型 (0=隐藏, 1=显示, 2=删除)

**Phản hồi mẫu (200):**
```json
{
  "success": true,
  "message": "批量操作成功",
  "affected_count": 5
}
```

**Trạng thái:** Hoàn thành

---

### 8. PATCH /admin/api/products/sort

**Mục tiêu:** 更新产品排序

**Tham số đầu vào (Body - JSON):**
- `sort` (object, required): 产品ID => 排序值的映射，例如：`{"1": 10, "2": 20}`

**Phản hồi mẫu (200):**
```json
{
  "success": true,
  "message": "排序更新成功"
}
```

**Trạng thái:** Hoàn thành

---

## Product Variant Management API

### 9. GET /admin/api/products/{id}/variants

**Mục tiêu:** 获取产品的所有变体列表

**Tham số đầu vào:**
- `id` (integer, required): 产品ID（URL参数）

**Phản hồi mẫu (200):**
```json
{
  "success": true,
  "data": [
    {
      "id": 1,
      "sku": "SKU-001",
      "product_id": 1,
      "option1_value": "500ml",
      "image": "https://example.com/variant1.jpg",
      "size_id": 1,
      "color_id": 1,
      "weight": 500,
      "price": 100000,
      "sale": 80000,
      "stock": 50,
      "position": 0,
      "color": {
        "id": 1,
        "name": "红色",
        "color": "#FF0000"
      },
      "size": {
        "id": 1,
        "name": "500ml",
        "unit": "ml"
      }
    }
  ]
}
```

**Trạng thái:** Hoàn thành

---

### 10. GET /admin/api/products/{id}/variants/{code}

**Mục tiêu:** 获取单个变体详情

**Tham số đầu vào:**
- `id` (integer, required): 产品ID（URL参数）
- `code` (integer, required): 变体ID（URL参数）

**Phản hồi mẫu (200):**
```json
{
  "success": true,
  "data": {
    "id": 1,
    "sku": "SKU-001",
    "product_id": 1,
    "option1_value": "500ml",
    "image": "https://example.com/variant1.jpg",
    "size_id": 1,
    "color_id": 1,
    "weight": 500,
    "price": 100000,
    "sale": 80000,
    "stock": 50,
    "position": 0
  }
}
```

**Trạng thái:** Hoàn thành

---

### 11. POST /admin/api/products/{id}/variants

**Mục tiêu:** 为产品创建新变体

**Tham số đầu vào (Body - JSON):**
- `id` (integer, required): 产品ID（URL参数）
- `sku` (string, required): SKU，必须唯一
- `option1_value` (string, optional): 变体选项值
- `image` (string, optional): 变体图片URL
- `size_id` (integer, optional): 尺寸ID
- `color_id` (integer, optional): 颜色ID
- `weight` (numeric, optional): 重量
- `price` (numeric, required): 价格
- `sale` (numeric, optional): 促销价
- `stock` (integer, optional): 库存数量

**Phản hồi mẫu (201):**
```json
{
  "success": true,
  "message": "变体创建成功",
  "data": {
    "id": 1,
    "sku": "SKU-001",
    "product_id": 1
  }
}
```

**Trạng thái:** Hoàn thành

---

### 12. PUT /admin/api/products/{id}/variants/{code}

**Mục tiêu:** 更新变体信息

**Tham số đầu vào:**
- `id` (integer, required): 产品ID（URL参数）
- `code` (integer, required): 变体ID（URL参数）
- Body参数同 POST /admin/api/products/{id}/variants

**Phản hồi mẫu (200):**
```json
{
  "success": true,
  "message": "变体更新成功",
  "data": {
    "id": 1,
    "sku": "SKU-001-UPDATED"
  }
}
```

**Trạng thái:** Hoàn thành

---

### 13. DELETE /admin/api/products/{id}/variants/{code}

**Mục tiêu:** 删除变体（如果变体已有订单则不允许删除）

**Tham số đầu vào:**
- `id` (integer, required): 产品ID（URL参数）
- `code` (integer, required): 变体ID（URL参数）

**Phản hồi mẫu (200):**
```json
{
  "success": true,
  "message": "变体删除成功"
}
```

**Phản hồi lỗi (400):**
```json
{
  "success": false,
  "message": "Sản phẩm đã có đơn hàng không thể xóa!"
}
```

**Trạng thái:** Hoàn thành

---

## Product Packaging Dimensions API

### 14. GET /admin/api/products/{id}/packaging

**Mục tiêu:** Lấy kích thước đóng gói của sản phẩm (Product)

**Tham số đầu vào:**
- `id` (integer, required): Product ID (URL parameter)

**Phản hồi mẫu (200):**
```json
{
  "success": true,
  "data": {
    "product_id": 9192,
    "weight": 300,
    "length": 10,
    "width": 10,
    "height": 10
  }
}
```

**Ghi chú:**
- `weight`: Trọng lượng (đơn vị: grams)
- `length`: Chiều dài (đơn vị: cm)
- `width`: Chiều rộng (đơn vị: cm)
- `height`: Chiều cao (đơn vị: cm)

**Trạng thái:** Hoàn thành

---

### 15. PUT /admin/api/products/{id}/packaging

**Mục tiêu:** Cập nhật kích thước đóng gói của sản phẩm (Product)

**Tham số đầu vào:**
- `id` (integer, required): Product ID (URL parameter)
- Body (JSON):
  - `weight` (numeric, optional, min: 0): Trọng lượng (grams)
  - `length` (numeric, optional, min: 0): Chiều dài (cm)
  - `width` (numeric, optional, min: 0): Chiều rộng (cm)
  - `height` (numeric, optional, min: 0): Chiều cao (cm)

**Phản hồi mẫu (200):**
```json
{
  "success": true,
  "message": "产品包装尺寸更新成功",
  "data": {
    "product_id": 9192,
    "weight": 300,
    "length": 10,
    "width": 10,
    "height": 10
  }
}
```

**Phản hồi lỗi (422 - Validation Error):**
```json
{
  "success": false,
  "message": "验证失败",
  "errors": {
    "weight": ["Trọng lượng phải là số"],
    "length": ["Chiều dài không được âm"]
  }
}
```

**Trạng thái:** Hoàn thành

---

### 16. GET /admin/api/products/{id}/variants/{code}/packaging

**Mục tiêu:** Lấy kích thước đóng gói của variant (ưu tiên variant, fallback về product nếu variant không có)

**Tham số đầu vào:**
- `id` (integer, required): Product ID (URL parameter)
- `code` (integer, required): Variant ID (URL parameter)

**Phản hồi mẫu (200):**
```json
{
  "success": true,
  "data": {
    "variant_id": 8410,
    "product_id": 9192,
    "weight": 300,
    "length": 10,
    "width": 10,
    "height": 10,
    "source": {
      "weight": "variant",
      "length": "product",
      "width": "variant",
      "height": "default"
    }
  }
}
```

**Ghi chú:**
- `source`: Cho biết nguồn dữ liệu của từng trường (`variant`, `product`, hoặc `default`)
- Nếu variant không có giá trị, sẽ fallback về product; nếu product cũng không có, sẽ trả về 0

**Trạng thái:** Hoàn thành

---

### 17. PUT /admin/api/products/{id}/variants/{code}/packaging

**Mục tiêu:** Cập nhật kích thước đóng gói của variant

**Tham số đầu vào:**
- `id` (integer, required): Product ID (URL parameter)
- `code` (integer, required): Variant ID (URL parameter)
- Body (JSON):
  - `weight` (numeric, optional, min: 0): Trọng lượng (grams)
  - `length` (numeric, optional, min: 0): Chiều dài (cm)
  - `width` (numeric, optional, min: 0): Chiều rộng (cm)
  - `height` (numeric, optional, min: 0): Chiều cao (cm)

**Phản hồi mẫu (200):**
```json
{
  "success": true,
  "message": "变体包装尺寸更新成功",
  "data": {
    "variant_id": 8410,
    "product_id": 9192,
    "weight": 500,
    "length": 15,
    "width": 12,
    "height": 8
  }
}
```

**Phản hồi lỗi (404 - Not Found):**
```json
{
  "success": false,
  "message": "变体不存在或不属于该产品"
}
```

**Trạng thái:** Hoàn thành

---

## Product Module Structure Analysis

### 当前模块结构

**位置:** `app/Modules/Product/`

**文件结构:**
```
Product/
├── Controllers/
│   └── ProductController.php (管理后台控制器 - 用于Web界面)
├── Models/
│   ├── Product.php (产品模型，使用posts表)
│   └── Variant.php (变体模型，使用variants表)
├── routes.php (管理后台路由配置)
└── Views/ (Blade模板文件)
    ├── index.blade.php
    ├── create.blade.php
    ├── edit.blade.php
    ├── variant.blade.php
    └── variantnew.blade.php
```

### 相关服务层

**位置:** `app/Services/Product/`

- `ProductService.php` - 产品业务逻辑服务
- `ProductServiceInterface.php` - 服务接口

**主要方法:**
- `createProduct(array $data): Product` - 创建产品
- `updateProduct(int $id, array $data): Product` - 更新产品
- `deleteProduct(int $id): bool` - 删除产品
- `getProductWithRelations(int $id): Product` - 获取产品及关联数据
- `getProducts(array $filters = [], int $perPage = 10)` - 获取产品列表（分页）

### 相关资源类

**位置:** `app/Http/Resources/Product/`

- `ProductResource.php` - 产品资源格式化类
- `ProductCollection.php` - 产品集合资源类

### 相关请求验证类

**位置:** `app/Http/Requests/Product/`

- `StoreProductRequest.php` - 创建产品请求验证
- `UpdateProductRequest.php` - 更新产品请求验证

### 数据库表结构

**posts 表 (Product模型):**
- `id`, `name`, `slug`, `image`, `gallery` (JSON), `video`
- `content`, `description`
- `status`, `type` (product/taxonomy), `has_variants`, `option1_name`
- `cat_id` (JSON数组), `brand_id`, `origin_id`
- `feature`, `best`, `stock`, `verified`
- `ingredient`, `seo_title`, `seo_description`, `cbmp`
- `sort`, `view`, `user_id`
- `created_at`, `updated_at`

**variants 表 (Variant模型):**
- `id`, `sku` (唯一), `product_id`
- `option1_value`, `image`
- `size_id`, `color_id`, `weight`
- `price`, `sale`, `stock`
- `position`, `user_id`
- `created_at`, `updated_at`

### 关联关系

- Product `belongsTo` Brand
- Product `belongsTo` Origin
- Product `hasMany` Variants
- Variant `belongsTo` Product
- Variant `belongsTo` Color
- Variant `belongsTo` Size

### 业务逻辑要点

1. **变体管理:**
   - 支持单产品模式（无变体）和多变体模式
   - 多变体模式使用 `variants_json` 格式同步变体
   - SKU必须唯一，系统会自动处理冲突

2. **图片处理:**
   - 支持R2云存储上传
   - 使用 `ImageService` 处理图片库
   - 自动从图片库中选择主图

3. **成分处理:**
   - 自动将文本成分链接到成分字典（IngredientPaulas）
   - 支持已处理HTML格式的成分内容

4. **订单检查:**
   - 删除产品/变体前检查是否已有订单
   - 有订单的产品/变体不允许删除

5. **Slug重定向:**
   - 产品slug变更时自动创建301重定向

---

## 待实现 API 端点

根据 `.cursorrules` 规范，需要在 `App\Modules\ApiAdmin\Controllers` 中创建以下控制器：

1. `ProductController` - 产品管理API控制器
2. 路由注册在 `app/Modules/ApiAdmin/routes.php`，使用前缀 `admin/api`

**实现计划:**
- 复用现有的 `ProductService` 处理业务逻辑
- 使用 `ProductResource` 格式化响应
- 遵循 RESTful 标准
- 统一错误处理和响应格式

---

## Public Product API (用于首页和公开页面)

### 14. GET /api/products/top-selling

**Mục tiêu:** 获取热销产品列表（Top sản phẩm bán chạy）

**Logic tính toán:**
- Tính tổng số lượng đã bán từ tất cả đơn hàng (trừ đơn hàng đã hủy - status = 4)
- Sắp xếp theo tổng số lượng đã bán giảm dần
- Nếu không đủ sản phẩm, bổ sung từ sản phẩm best hoặc sản phẩm mới nhất

**Tham số đầu vào (Query Params):**
- `limit` (integer, optional): 返回数量，默认 10

**Phản hồi mẫu (200):**
```json
{
  "success": true,
  "data": [
    {
      "id": 1,
      "name": "产品名称",
      "slug": "product-slug",
      "image": "https://example.com/image.jpg",
      "brand_id": 1,
      "brand_name": "品牌名称",
      "brand_slug": "brand-slug",
      "price": 100000,
      "sale": 80000,
      "price_info": {
        "price": 80000,
        "original_price": 100000,
        "type": "normal",
        "label": "",
        "discount_percent": 20
      },
      "stock": 1,
      "best": 1,
      "is_new": 0,
      "total_sold": 150,
      "total_sold_month": 25
    }
  ],
  "count": 10
}
```

**Response Fields:**
- `total_sold` (integer): Tổng số lượng đã bán từ tất cả đơn hàng (trừ đơn hàng đã hủy)
- `total_sold_month` (integer): Số lượng đã bán trong tháng hiện tại

**Trạng thái:** Hoàn thành (已更新 - Tính toán dựa trên tất cả đơn hàng)

---

### 15. GET /api/products/by-category/{id}

**Mục tiêu:** 根据分类ID获取产品列表

**Tham số đầu vào:**
- `id` (integer, required): 分类ID（URL参数）
- `limit` (integer, optional): 返回数量，默认 20

**Phản hồi mẫu (200):**
```json
{
  "success": true,
  "data": [
    {
      "id": 1,
      "name": "产品名称",
      "slug": "product-slug",
      "image": "https://example.com/image.jpg",
      "brand_id": 1,
      "price": 100000,
      "sale": 80000,
      "stock": 1,
      "best": 0,
      "is_new": 1
    }
  ],
  "count": 20
}
```

**Trạng thái:** Hoàn thành

---

### 16. GET /api/products/flash-sale

**Mục tiêu:** 获取当前 Flash Sale 产品列表

**Tham số đầu vào:** 无

**Phản hồi mẫu (200):**
```json
{
  "success": true,
  "data": [
    {
      "id": 1,
      "name": "产品名称",
      "slug": "product-slug",
      "image": "https://example.com/image.jpg",
      "brand_id": 1,
      "price": 100000,
      "sale": 80000,
      "price_sale": 70000,
      "stock": 1,
      "best": 1,
      "is_new": 0,
      "flash_sale": {
        "number": 100,
        "buy": 50,
        "remaining": 50
      }
    }
  ],
  "flash_sale": {
    "id": 1,
    "name": "Flash Sale 名称",
    "start": 1704067200,
    "end": 1704153600,
    "end_date": "2024-01-02 00:00:00",
    "end_timestamp": 1704153600,
    "total_products": 25
  },
  "count": 5
}
```

**Phản hồi mẫu (无 Flash Sale):**
```json
{
  "success": true,
  "data": [],
  "flash_sale": null,
  "count": 0
}
```

**Trạng thái:** Hoàn thành

---

### 17. GET /api/products/{id}/price-info

**Mục tiêu:** 获取产品价格信息（包括 Flash Sale、Marketing Campaign 等）

**Tham số đầu vào:**
- `id` (integer, required): 产品ID（URL参数）

**Phản hồi mẫu (200):**
```json
{
  "success": true,
  "data": {
    "price": 100000,
    "sale": 80000,
    "price_info": {
      "price": 70000,
      "original_price": 100000,
      "type": "flashsale",
      "label": "Flash Sale"
    }
  }
}
```

**Trạng thái:** Hoàn thành

---

### 18. GET /api/products/{slug}/detail

**Mục tiêu:** 获取产品详情信息（包括基本信息、图片库、变体、品牌、分类、评分、销量、Flash Sale、Deal 等）

**Tham số đầu vào:**
- `slug` (string, required): 产品 slug（URL参数）

**Phản hồi mẫu (200):**
```json
{
  "success": true,
  "data": {
    "id": 1,
    "name": "产品名称",
    "slug": "product-slug",
    "image": "https://cdn.lica.vn/uploads/images/product.jpg",
    "video": null,
    "gallery": [
      "https://cdn.lica.vn/uploads/images/gallery1.jpg",
      "https://cdn.lica.vn/uploads/images/gallery2.jpg"
    ],
    "description": "产品描述",
    "content": "产品详细内容",
    "seo_title": "SEO标题",
    "seo_description": "SEO描述",
    "stock": 100,
    "best": 1,
    "is_new": 0,
    "cbmp": "CBMP123456",
    "option1_name": "Phân loại",
    "has_variants": 1,
    "brand": {
      "id": 1,
      "name": "品牌名称",
      "slug": "brand-slug"
    },
    "origin": {
      "id": 1,
      "name": "产地名称"
    },
    "category": {
      "id": 1,
      "name": "分类名称",
      "slug": "category-slug"
    },
    "first_variant": {
      "id": 1,
      "sku": "SKU123",
      "price": 100000,
      "sale": 80000,
      "stock": 50
    },
    "variants": [
      {
        "id": 1,
        "sku": "SKU123",
        "option1_value": "红色 / 大号",
        "image": "https://cdn.lica.vn/uploads/images/variant1.jpg",
        "price": 100000,
        "sale": 80000,
        "stock": 50,
        "weight": 0.5,
        "size_id": 1,
        "color_id": 1,
        "color": {
          "id": 1,
          "name": "红色"
        },
        "size": {
          "id": 1,
          "name": "大号",
          "unit": "ml"
        },
        "price_info": {
          "final_price": 70000,
          "original_price": 100000,
          "html": "<p>70,000đ</p><del>100,000đ</del><div class=\"tag\"><span>-30%</span></div>"
        },
        "option_label": "红色 / 大号"
      }
    ],
    "variants_count": 1,
    "rating": {
      "average": 4.5,
      "count": 120,
      "sum": 540
    },
    "total_sold": 1500,
    "rates": [
      {
        "id": 1,
        "rate": 5,
        "comment": "很好用",
        "user_name": "用户A",
        "created_at": "2024-01-01T00:00:00.000000Z"
      }
    ],
    "flash_sale": {
      "id": 1,
      "name": "Flash Sale 名称",
      "start": 1704067200,
      "end": 1704153600,
      "end_date": "2024/01/02 00:00:00",
      "price_sale": 60000,
      "number": 100,
      "buy": 50,
      "remaining": 50
    },
    "deal": {
      "id": 1,
      "name": "Deal 名称",
      "limited": 2,
      "sale_deals": [
        {
          "id": 1,
          "product_id": 2,
          "product_name": "搭配产品",
          "product_image": "https://cdn.lica.vn/uploads/images/deal-product.jpg",
          "variant_id": 2,
          "price": 50000,
          "original_price": 80000
        }
      ]
    },
    "related_products": [
      {
        "id": 2,
        "name": "相关产品",
        "slug": "related-product-slug",
        "image": "https://cdn.lica.vn/uploads/images/related.jpg",
        "brand_id": 1,
        "brand_name": "品牌名称",
        "brand_slug": "brand-slug",
        "price": 90000,
        "sale": 70000,
        "stock": 30,
        "best": 0,
        "is_new": 1,
        "deal": null
      }
    ]
  }
}
```

**Phản hồi mẫu (404):**
```json
{
  "success": false,
  "message": "产品不存在"
}
```

**Trạng thái:** Hoàn thành

---

### 19. GET /api/v1/deals/active-bundles

**Mục tiêu:** 获取正在进行中的 Deal Sốc 列表（主品 + 搭配品 bundle），用于前台展示。

**Tham số đầu vào (Query Params):** 无

**Phản hồi mẫu (200):**
```json
{
  "success": true,
  "data": [
    {
      "id": 1,
      "name": "Deal sốc tháng 2",
      "start": 1706745600,
      "end": 1709337599,
      "status": "1",
      "limited": 3,
      "is_active": true,
      "products": [
        {
          "id": 10,
          "product_id": 5,
          "variant_id": 12,
          "status": "1",
          "product": {
            "id": 5,
            "name": "Sản phẩm chính A",
            "slug": "san-pham-chinh-a",
            "image": "https://cdn.lica.vn/uploads/images/a.jpg",
            "has_variants": 1
          },
          "variant": {
            "id": 12,
            "sku": "SKU-A-500",
            "option1_value": "500ml"
          }
        }
      ],
      "sale_products": [
        {
          "id": 20,
          "product_id": 8,
          "variant_id": 15,
          "qty": 2,
          "status": "1",
          "product": {
            "id": 8,
            "name": "Sản phẩm mua kèm B",
            "slug": "san-pham-b",
            "image": "https://cdn.lica.vn/uploads/images/b.jpg",
            "has_variants": 1
          },
          "variant": {
            "id": 15,
            "sku": "SKU-B-250",
            "option1_value": "250ml"
          },
          "deal_price": 150000,
          "effective_price": {
            "price": 150000,
            "original_price": 200000,
            "type": "deal",
            "label": "Deal Sốc",
            "discount_percent": 25
          },
          "stock": 30
        }
      ]
    }
  ],
  "count": 1
}
```

**Trạng thái:** Hoàn thành

---

### 20. GET /api/v1/deals/{id}/bundle

**Mục tiêu:** 获取单个 Deal Sốc 的 bundle 详情，供前台 landing / 弹窗使用。

**Tham số đầu vào:**
- `id` (integer, required): Deal ID（URL参数）

**Phản hồi mẫu (200):**
```json
{
  "success": true,
  "data": {
    "id": 1,
    "name": "Deal sốc tháng 2",
    "start": 1706745600,
    "end": 1709337599,
    "status": "1",
    "limited": 3,
    "is_active": true,
    "products": [
      {
        "id": 10,
        "product_id": 5,
        "variant_id": 12,
        "status": "1",
        "product": {
          "id": 5,
          "name": "Sản phẩm chính A",
          "slug": "san-pham-chinh-a",
          "image": "https://cdn.lica.vn/uploads/images/a.jpg",
          "has_variants": 1
        },
        "variant": {
          "id": 12,
          "sku": "SKU-A-500",
          "option1_value": "500ml"
        }
      }
    ],
    "sale_products": [
      {
        "id": 20,
        "product_id": 8,
        "variant_id": 15,
        "qty": 2,
        "status": "1",
        "product": {
          "id": 8,
          "name": "Sản phẩm mua kèm B",
          "slug": "san-pham-b",
          "image": "https://cdn.lica.vn/uploads/images/b.jpg",
          "has_variants": 1
        },
        "variant": {
          "id": 15,
          "sku": "SKU-B-250",
          "option1_value": "250ml"
        },
        "deal_price": 150000,
        "effective_price": {
          "price": 150000,
          "original_price": 200000,
          "type": "deal",
          "label": "Deal Sốc",
          "discount_percent": 25
        },
        "stock": 30
      }
    ]
  }
}
```

**Phản hồi lỗi (404):**
```json
{
  "success": false,
  "message": "Deal không tồn tại hoặc không còn hoạt động"
}
```

**Trạng thái:** Hoàn thành

---


## Flash Sale Management API

### 1. GET /admin/api/flash-sales

**Mục tiêu:** 获取 Flash Sale 列表，支持分页和过滤

**Tham số đầu vào (Query Params):**
- `page` (integer, optional): 页码，默认 1
- `limit` (integer, optional): 每页数量，默认 10，最大 100
- `status` (string, optional): 状态过滤 (0=未激活, 1=激活)
- `keyword` (string, optional): 关键词搜索

**Phản hồi mẫu (200):**
```json
{
  "success": true,
  "data": [
    {
      "id": 1,
      "name": "Flash Sale Tháng 1",
      "start": "2024-01-15T00:00:00.000000Z",
      "end": "2024-01-20T23:59:59.000000Z",
      "start_timestamp": 1705276800,
      "end_timestamp": 1705708799,
      "status": "1",
      "is_active": true,
      "countdown_seconds": 432000,
      "total_products": 25,
      "created_at": "2024-01-10T00:00:00.000000Z",
      "updated_at": "2024-01-10T00:00:00.000000Z"
    }
  ],
  "pagination": {
    "current_page": 1,
    "per_page": 10,
    "total": 50,
    "last_page": 5
  }
}
```

**Trạng thái:** Hoàn thành

---

### 2. GET /admin/api/flash-sales/{id}

**Mục tiêu:** 获取 Flash Sale 详情（包含产品列表）

**Tham số đầu vào:**
- `id` (integer, required): Flash Sale ID（URL参数）

**Phản hồi mẫu (200):**
```json
{
  "success": true,
  "data": {
    "id": 1,
    "start": "2024-01-15T00:00:00.000000Z",
    "end": "2024-01-20T23:59:59.000000Z",
    "status": "1",
    "is_active": true,
    "countdown_seconds": 432000,
    "products": [
      {
        "id": 1,
        "flashsale_id": 1,
        "product_id": 10,
        "variant_id": 5,
        "price_sale": 150000,
        "number": 100,
        "buy": 45,
        "remaining": 55,
        "is_available": true,
        "original_price": 200000,
        "discount_percent": 25,
        "variant": {
          "id": 5,
          "sku": "SKU-001",
          "option1_value": "500ml",
          "price": 200000
        },
        "product": {
          "id": 10,
          "name": "Sản phẩm",
          "slug": "san-pham",
          "image": "https://..."
        }
      }
    ]
  }
}
```

**Trạng thái:** Hoàn thành

---

### 3. POST /admin/api/flash-sales

**Mục tiêu:** 创建新的 Flash Sale

**Request Body:**
```json
{
  "start": "2024-01-15 00:00:00",
  "end": "2024-01-20 23:59:59",
  "status": "1",
  "products": [
    {
      "product_id": 10,
      "variant_id": 5,
      "price_sale": 150000,
      "number": 100
    },
    {
      "product_id": 10,
      "variant_id": null,
      "price_sale": 140000,
      "number": 50
    }
  ]
}
```

**Validation:**
- `start`: required, date format
- `end`: required, date format, after:start
- `status`: required, in:0,1
- `products`: array, optional
- `products.*.product_id`: required, exists:posts,id
- `products.*.variant_id`: nullable, exists:variants,id (必须属于 product_id)
- `products.*.price_sale`: required, numeric, min:0
- `products.*.number`: required, integer, min:1

**Stock Validation (新增):**
- 所有产品的库存必须 > 0 才能参与 Flash Sale
- 有 variant 的产品：从 warehouse 系统获取实际库存
- 无 variant 的产品：使用 product.stock 字段或默认 variant 的库存
- 如果产品库存为 0，返回 422 错误

**Phản hồi mẫu (201):**
```json
{
  "success": true,
  "message": "Tạo Flash Sale thành công",
  "data": {
    // FlashSaleDetailResource
  }
}
```

**Trạng thái:** Hoàn thành

---

### 4. PUT /admin/api/flash-sales/{id}

**Mục tiêu:** 更新 Flash Sale

**Request Body:** 同 POST，但所有字段都是可选的

**Logic:**
- 更新 flashsales 表
- 删除不在 request 中的 productsales
- 更新/创建新的 productsales

**Stock Validation (新增):**
- 更新产品时，所有产品的库存必须 > 0
- 如果产品库存为 0，返回 422 错误

**Phản hồi mẫu (200):**
```json
{
  "success": true,
  "message": "Cập nhật Flash Sale thành công",
  "data": {
    // FlashSaleDetailResource
  }
}
```

**Trạng thái:** Hoàn thành

---

### 5. DELETE /admin/api/flash-sales/{id}

**Mục tiêu:** 删除 Flash Sale

**Phản hồi mẫu (200):**
```json
{
  "success": true,
  "message": "Xóa Flash Sale thành công"
}
```

**Trạng thái:** Hoàn thành

---

### 6. POST /admin/api/flash-sales/{id}/status

**Mục tiêu:** 更新 Flash Sale 状态

**Request Body:**
```json
{
  "status": "1"
}
```

**Phản hồi mẫu (200):**
```json
{
  "success": true,
  "message": "Cập nhật trạng thái thành công",
  "data": {
    // FlashSaleResource
  }
}
```

**Trạng thái:** Hoàn thành

---

### 7. POST /admin/api/flash-sales/search-products

**Mục tiêu:** 搜索产品以添加到 Flash Sale（Admin）

**Request Body (JSON):**
- `keyword` (string, required): 搜索关键词

**Query Parameters:**
- `page` (integer, optional): 页码，默认 1
- `limit` (integer, optional): 每页数量，默认 50，最大 100

**Stock Filtering (新增):**
- 自动过滤掉库存为 0 的产品
- 使用 warehouse 系统获取实际库存（而非 product.stock 字段）
- 对于有 variant 的产品：
  - 只显示库存 > 0 的 variant
  - 如果所有 variant 的库存都为 0，则完全过滤掉该产品
- 对于无 variant 的产品：
  - 如果库存为 0，则过滤掉该产品

**Phản hồi mẫu (200):**
```json
{
  "success": true,
  "data": [
    {
      "id": 10,
      "name": "产品名称",
      "image": "https://...",
      "has_variants": true,
      "price": 200000,
      "stock": 50,
      "variants": [
        {
          "id": 5,
          "sku": "SKU-001",
          "option1_value": "500ml",
          "price": 200000,
          "stock": 50
        }
      ]
    }
  ],
  "pagination": {
    "current_page": 1,
    "per_page": 50,
    "total": 100,
    "last_page": 2
  }
}
```

**Lưu ý:**
- `stock` 字段显示的是从 warehouse 系统获取的实际库存
- 返回的产品列表已自动过滤掉库存为 0 的产品和 variant
- 分页信息基于原始查询结果，实际返回的数据可能少于分页显示的数量（因为过滤）

**Trạng thái:** Hoàn thành (已升级 - 添加库存过滤)

---

---

## Order Management API

### 1. GET /admin/api/orders

**Mục tiêu:** 获取订单列表，支持分页和过滤

**Tham số đầu vào (Query Params):**
- `page` (integer, optional): 页码，默认 1
- `limit` (integer, optional): 每页数量，默认 10，最大 100
- `status` (string, optional): 状态过滤 (0=待处理, 1=已确认, 2=已发货, 3=已完成, 4=已取消)
- `payment` (string, optional): 支付状态过滤 (0=未支付, 1=已支付, 2=已退款)
- `ship` (string, optional): 运输状态过滤 (0=未发货, 1=已发货, 2=已收货, 3=已退货, 4=已取消)
- `keyword` (string, optional): 关键词搜索（订单号、姓名、电话）
- `date_from` (string, optional): 开始日期 (YYYY-MM-DD)
- `date_to` (string, optional): 结束日期 (YYYY-MM-DD)
- `user_id` (integer, optional): 客户ID过滤

**Phản hồi mẫu (200):**
```json
{
  "success": true,
  "data": [
    {
      "id": 123,
      "code": "1704067200",
      "name": "Nguyễn Văn A",
      "phone": "0123456789",
      "email": "email@example.com",
      "address": "123 Đường ABC",
      "province": {
        "id": 1,
        "name": "Hà Nội"
      },
      "district": {
        "id": 1,
        "name": "Quận 1"
      },
      "ward": {
        "id": 1,
        "name": "Phường 1"
      },
      "total": 500000,
      "sale": 50000,
      "fee_ship": 30000,
      "status": "0",
      "status_label": "Chờ xử lý",
      "promotion": {
        "id": 1,
        "code": "SALE10"
      },
      "member": {
        "id": 1,
        "name": "Nguyễn Văn A"
      },
      "items_count": 3,
      "created_at": "2024-01-01T00:00:00.000000Z",
      "updated_at": "2024-01-01T00:00:00.000000Z"
    }
  ],
  "pagination": {
    "current_page": 1,
    "per_page": 10,
    "total": 100,
    "last_page": 10
  }
}
```

**Trạng thái:** Hoàn thành

---

### 2. GET /admin/api/orders/{id}

**Mục tiêu:** 获取订单详情（包含订单明细）

**Tham số đầu vào:**
- `id` (integer, required): 订单ID（URL参数）

**Phản hồi mẫu (200):**
```json
{
  "success": true,
  "data": {
    "id": 123,
    "code": "1704067200",
    "name": "Nguyễn Văn A",
    "phone": "0123456789",
    "email": "email@example.com",
    "address": "123 Đường ABC",
    "province": {
      "id": 1,
      "name": "Hà Nội"
    },
    "district": {
      "id": 1,
      "name": "Quận 1"
    },
    "ward": {
      "id": 1,
      "name": "Phường 1"
    },
    "remark": "Ghi chú",
    "total": 500000,
    "sale": 50000,
    "fee_ship": 30000,
    "status": "0",
    "status_label": "Chờ xử lý",
    "promotion": {
      "id": 1,
      "code": "SALE10",
      "name": "Giảm 10%"
    },
    "member": {
      "id": 1,
      "name": "Nguyễn Văn A",
      "email": "email@example.com"
    },
    "items": [
      {
        "id": 1,
        "product_id": 10,
        "product_name": "Sản phẩm",
        "product_slug": "san-pham",
        "variant_id": 1,
        "variant": {
          "id": 1,
          "sku": "SKU-001",
          "option1_value": "500ml"
        },
        "color": {
          "id": 1,
          "name": "Đỏ"
        },
        "size": {
          "id": 1,
          "name": "500ml",
          "unit": "ml"
        },
        "price": 100000,
        "qty": 2,
        "subtotal": 200000,
        "image": "https://cdn.lica.vn/uploads/images/product.jpg",
        "weight": 1.0
      }
    ],
    "created_at": "2024-01-01T00:00:00.000000Z",
    "updated_at": "2024-01-01T00:00:00.000000Z"
  }
}
```

**Trạng thái:** Hoàn thành

---

### 3. PATCH /admin/api/orders/{id}/status

**Mục tiêu:** 更新订单状态（包括库存管理逻辑）

**Tham số đầu vào:**
- `id` (integer, required): 订单ID（URL参数）

**Body - JSON:**
- `status` (string, required): 状态值 (0=待处理, 1=已确认, 2=已发货, 3=已完成, 4=已取消)
- `payment` (string, optional): 支付状态 (0=未支付, 1=已支付, 2=已退款)
- `ship` (string, optional): 运输状态 (0=未发货, 1=已发货, 2=已收货, 3=已退货, 4=已取消)
- `content` (string, optional): 管理员备注

**Logic xử lý:**
- Khi chuyển từ trạng thái khác sang "Đã hủy" (status=4): Hoàn lại tồn kho cho tất cả sản phẩm
- Khi chuyển từ "Đã hủy" sang trạng thái khác: Trừ lại tồn kho (nếu đủ tồn kho)
- Sử dụng Database Transaction và Row Locking để đảm bảo tính nhất quán

**Phản hồi mẫu (200):**
```json
{
  "success": true,
  "message": "Cập nhật trạng thái thành công",
  "data": {
    "id": 123,
    "code": "1704067200",
    "status": "1",
    "status_label": "Đã xác nhận",
    "payment": "0",
    "ship": "0",
    "items": [...]
  }
}
```

**Phản hồi lỗi (400):**
```json
{
  "success": false,
  "message": "Không đủ tồn kho cho sản phẩm: Tên sản phẩm"
}
```

**Trạng thái:** Hoàn thành

---

### 4. PUT /admin/api/orders/{id}

**Mục tiêu:** 更新订单信息（客户信息、地址、备注、运费、产品列表）

**Tham số đầu vào:**
- `id` (integer, required): 订单ID（URL参数）

**Body - JSON:**
- `name` (string, optional): 客户姓名
- `phone` (string, optional): 电话号码
- `email` (string, optional): 邮箱
- `address` (string, optional): 详细地址
- `provinceid` (integer, optional): 省份ID
- `districtid` (integer, optional): 区县ID
- `wardid` (integer, optional): 街道ID
- `remark` (string, optional): 客户备注
- `content` (string, optional): 管理员备注
- `fee_ship` (numeric, optional): 运费
- `items` (array, optional): 产品列表
  - `id` (integer, optional): OrderDetail ID（如果存在则更新，不存在则新增）
  - `product_id` (integer, required): 产品ID
  - `variant_id` (integer, optional): 变体ID
  - `qty` (integer, required): 数量
  - `price` (numeric, optional): 单价（如果不提供则使用当前价格）

**Logic xử lý:**
- 更新客户信息和地址
- 如果提供 `items` 数组：
  - 更新现有 items（如果提供 `id`）
  - 添加新 items（如果不提供 `id`）
  - 删除不在数组中的 items
  - 自动调整库存（增加/减少数量时）
  - 重新计算订单总金额
- 使用 Database Transaction 和 Row Locking
- 如果订单已取消（status=4），不允许更新

**Phản hồi mẫu (200):**
```json
{
  "success": true,
  "message": "Cập nhật đơn hàng thành công",
  "data": {
    "id": 123,
    "code": "1704067200",
    "name": "Nguyễn Văn A",
    "phone": "0123456789",
    "items": [...],
    "total": 500000,
    "fee_ship": 30000,
    "final_total": 480000
  }
}
```

**Phản hồi lỗi (400):**
```json
{
  "success": false,
  "message": "Không thể chỉnh sửa đơn hàng đã hủy"
}
```

**Phản hồi lỗi (400 - 库存不足):**
```json
{
  "success": false,
  "message": "Không đủ tồn kho cho sản phẩm: Tên sản phẩm"
}
```

**Trạng thái:** Hoàn thành

---

## Slider Management API

### 1. GET /admin/api/sliders

**Mục tiêu:** 获取slider列表，支持分页和过滤

**Tham số đầu vào (Query Params):**
- `page` (integer, optional): 页码，默认 1
- `limit` (integer, optional): 每页数量，默认 10，最大 100
- `status` (string, optional): 状态过滤 (0=隐藏, 1=显示)
- `display` (string, optional): 设备类型过滤 (desktop/mobile)
- `keyword` (string, optional): 关键词搜索（slider名称）

**Phản hồi mẫu (200):**
```json
{
  "success": true,
  "data": [
    {
      "id": 1,
      "name": "Slider Tiêu Đề",
      "link": "https://example.com",
      "image": "https://r2-domain.com/uploads/sliders/image.jpg",
      "display": "desktop",
      "status": "1",
      "sort": 1,
      "user": {
        "id": 1,
        "name": "Admin User"
      },
      "created_at": "2024-01-01T00:00:00.000000Z",
      "updated_at": "2024-01-01T00:00:00.000000Z"
    }
  ],
  "pagination": {
    "current_page": 1,
    "per_page": 10,
    "total": 50,
    "last_page": 5
  }
}
```

**Trạng thái:** Hoàn thành

---

### 2. GET /admin/api/sliders/{id}

**Mục tiêu:** 获取单个slider详情

**Tham số đầu vào:**
- `id` (integer, required): Slider ID（URL参数）

**Phản hồi mẫu (200):**
```json
{
  "success": true,
  "data": {
    "id": 1,
    "name": "Slider Tiêu Đề",
    "link": "https://example.com",
    "image": "https://r2-domain.com/uploads/sliders/image.jpg",
    "display": "desktop",
    "status": "1",
    "sort": 1,
    "user": {
      "id": 1,
      "name": "Admin User"
    },
    "created_at": "2024-01-01T00:00:00.000000Z",
    "updated_at": "2024-01-01T00:00:00.000000Z"
  }
}
```

**Trạng thái:** Hoàn thành

---

### 3. POST /admin/api/sliders

**Mục tiêu:** 创建新slider

**Tham số đầu vào (Body - JSON):**
- `name` (string, required): Slider标题，1-250字符
- `link` (string, optional): 链接URL
- `image` (string, optional): 图片路径
- `display` (string, required): 设备类型 (desktop/mobile)
- `status` (string, required): 状态 (0/1)

**Phản hồi mẫu (201):**
```json
{
  "success": true,
  "message": "Tạo slider thành công",
  "data": {
    "id": 1,
    "name": "Slider Tiêu Đề",
    "link": "https://example.com",
    "image": "https://r2-domain.com/uploads/sliders/image.jpg",
    "display": "desktop",
    "status": "1",
    "sort": 0,
    "user": {
      "id": 1,
      "name": "Admin User"
    },
    "created_at": "2024-01-01T00:00:00.000000Z",
    "updated_at": "2024-01-01T00:00:00.000000Z"
  }
}
```

**Trạng thái:** Hoàn thành

---

### 4. PUT /admin/api/sliders/{id}

**Mục tiêu:** 更新slider

**Tham số đầu vào:**
- `id` (integer, required): Slider ID（URL参数）

**Body - JSON:** (同POST，所有字段)

**Phản hồi mẫu (200):**
```json
{
  "success": true,
  "message": "Cập nhật slider thành công",
  "data": {
    "id": 1,
    "name": "Slider Tiêu Đề Updated",
    "link": "https://example.com/new",
    "image": "https://r2-domain.com/uploads/sliders/image-new.jpg",
    "display": "mobile",
    "status": "1",
    "sort": 1,
    "user": {
      "id": 1,
      "name": "Admin User"
    },
    "created_at": "2024-01-01T00:00:00.000000Z",
    "updated_at": "2024-01-01T00:00:00.000000Z"
  }
}
```

**Trạng thái:** Hoàn thành

---

### 5. DELETE /admin/api/sliders/{id}

**Mục tiêu:** 删除slider

**Tham số đầu vào:**
- `id` (integer, required): Slider ID（URL参数）

**Phản hồi mẫu (200):**
```json
{
  "success": true,
  "message": "Xóa slider thành công"
}
```

**Trạng thái:** Hoàn thành

---

### 6. PATCH /admin/api/sliders/{id}/status

**Mục tiêu:** 更新slider状态

**Tham số đầu vào:**
- `id` (integer, required): Slider ID（URL参数）

**Body - JSON:**
- `status` (string, required): 状态值 (0=隐藏, 1=显示)

**Phản hồi mẫu (200):**
```json
{
  "success": true,
  "message": "Cập nhật trạng thái thành công",
  "data": {
    "id": 1,
    "name": "Slider Tiêu Đề",
    "status": "1",
    "display": "desktop",
    "created_at": "2024-01-01T00:00:00.000000Z",
    "updated_at": "2024-01-01T00:00:00.000000Z"
  }
}
```

**Trạng thái:** Hoàn thành

---

## Public Slider API V1

### 1. GET /api/v1/sliders

**Mục tiêu:** 获取活跃slider列表（公开API，无需认证）

**Tham số đầu vào (Query Params):**
- `display` (string, optional): 设备类型过滤
  - `desktop` - 仅获取desktop slider
  - `mobile` - 仅获取mobile slider
  - 不提供 - 获取所有slider

**Phản hồi mẫu (200):**
```json
{
  "success": true,
  "data": [
    {
      "id": 1,
      "name": "Slider Tiêu Đề",
      "link": "https://example.com",
      "image": "https://r2-domain.com/uploads/sliders/image.jpg",
      "display": "desktop",
      "status": "1",
      "sort": 1,
      "created_at": "2024-01-01T00:00:00.000000Z",
      "updated_at": "2024-01-01T00:00:00.000000Z"
    }
  ]
}
```

**Lưu ý:** 
- 仅返回 `status = 1` 的slider
- 按 `sort` ASC排序，然后按 `created_at` DESC排序
- 无需认证，公开访问

**Trạng thái:** Hoàn thành

---

---

## User Order API V1 (Authenticated Users)

### 1. GET /api/v1/orders

**Mục tiêu:** 获取用户订单列表（需要登录认证）

**Authentication:** Required (auth:member)

**Tham số đầu vào (Query Params):**
- `page` (integer, optional): 页码，默认 1
- `limit` (integer, optional): 每页数量，默认 10，最大 50
- `status` (string, optional): 状态过滤 (0=待处理, 1=已确认, 2=已发货, 3=已完成, 4=已取消)
- `payment` (string, optional): 支付状态过滤 (0=未支付, 1=已支付, 2=已退款)
- `ship` (string, optional): 运输状态过滤 (0=未发货, 1=已发货, 2=已收货, 3=已退货, 4=已取消)
- `date_from` (string, optional): 开始日期 (YYYY-MM-DD)
- `date_to` (string, optional): 结束日期 (YYYY-MM-DD)

**Phản hồi mẫu (200):**
```json
{
  "success": true,
  "data": [
    {
      "id": 123,
      "code": "1680426297",
      "date": "02-04-2023",
      "date_raw": "2023-04-02T00:00:00.000000Z",
      "address": "Hà Đông, Mỗ Lao",
      "total": 430000,
      "total_formatted": "430,000₫",
      "payment_status": "0",
      "payment_label": "Chưa thanh toán",
      "ship_status": "0",
      "ship_label": "Chưa giao hàng",
      "status": "0",
      "status_label": "Chờ xử lý"
    }
  ],
  "pagination": {
    "current_page": 1,
    "per_page": 10,
    "total": 5,
    "last_page": 1
  }
}
```

**Phản hồi lỗi (401):**
```json
{
  "success": false,
  "message": "Unauthenticated"
}
```

**Trạng thái:** Hoàn thành

---

### 2. GET /api/v1/orders/{code}

**Mục tiêu:** 获取用户订单详情（需要登录认证）

**Authentication:** Required (auth:member)

**Tham số đầu vào:**
- `code` (string, required): 订单号（URL参数）

**Phản hồi mẫu (200):**
```json
{
  "success": true,
  "data": {
    "id": 123,
    "code": "1680426297",
    "name": "Nguyễn Văn A",
    "phone": "0123456789",
    "email": "email@example.com",
    "address": "123 Đường ABC",
    "province": {
      "id": 1,
      "name": "Hà Nội"
    },
    "district": {
      "id": 1,
      "name": "Quận 1"
    },
    "ward": {
      "id": 1,
      "name": "Phường 1"
    },
    "remark": "Ghi chú",
    "total": 430000,
    "sale": 0,
    "fee_ship": 30000,
    "final_total": 460000,
    "status": "0",
    "status_label": "Chờ xử lý",
    "payment": "0",
    "payment_label": "Chưa thanh toán",
    "ship": "0",
    "ship_label": "Chưa giao hàng",
    "items": [
      {
        "id": 1,
        "product_id": 10,
        "product_name": "Sản phẩm",
        "product_slug": "san-pham",
        "variant_id": 1,
        "variant": {
          "id": 1,
          "sku": "SKU-001",
          "option1_value": "500ml"
        },
        "price": 200000,
        "qty": 2,
        "subtotal": 400000,
        "image": "https://cdn.lica.vn/uploads/images/product.jpg",
        "weight": 1.0
      }
    ],
    "created_at": "2023-04-02T00:00:00.000000Z",
    "updated_at": "2023-04-02T00:00:00.000000Z"
  }
}
```

**Phản hồi lỗi (404):**
```json
{
  "success": false,
  "message": "Đơn hàng không tồn tại hoặc không thuộc về bạn"
}
```

**Phản hồi lỗi (401):**
```json
{
  "success": false,
  "message": "Unauthenticated"
}
```

**Trạng thái:** Hoàn thành

---

---

## Deal Management API

### 1. GET /admin/api/deals

**Mục tiêu:** 获取Deal列表，支持分页和过滤

**Tham số đầu vào (Query Params):**
- `page` (integer, optional): 页码，默认 1
- `limit` (integer, optional): 每页数量，默认 10
- `status` (string, optional): 状态过滤 (0=未激活, 1=激活)
- `keyword` (string, optional): 关键词搜索（Deal名称）

**Phản hồi mẫu (200):**
```json
{
  "success": true,
  "data": [
    {
      "id": 1,
      "name": "Deal sốc tháng 1",
      "start": "2024-01-01T00:00:00+00:00",
      "end": "2024-01-31T23:59:59+00:00",
      "start_timestamp": 1704067200,
      "end_timestamp": 1706745599,
      "status": "1",
      "status_text": "Kích hoạt",
      "limited": 3,
      "is_active": true,
      "created_by": {
        "id": 1,
        "name": "Admin User"
      },
      "created_at": "2024-01-01T00:00:00.000000Z",
      "updated_at": "2024-01-15T10:30:00.000000Z"
    }
  ],
  "pagination": {
    "current_page": 1,
    "per_page": 10,
    "total": 25,
    "last_page": 3
  }
}
```

**Trạng thái:** Hoàn thành

---

### 2. GET /admin/api/deals/{id}

**Mục tiêu:** 获取单个Deal详情（包含产品列表和促销产品列表）

**Tham số đầu vào:**
- `id` (integer, required): Deal ID（URL参数）

**Phản hồi mẫu (200):**
```json
{
  "success": true,
  "data": {
    "id": 1,
    "name": "Deal sốc tháng 1",
    "start": "2024-01-01T00:00:00+00:00",
    "end": "2024-01-31T23:59:59+00:00",
    "start_timestamp": 1704067200,
    "end_timestamp": 1706745599,
    "status": "1",
    "status_text": "Kích hoạt",
    "limited": 3,
    "is_active": true,
    "created_by": {
      "id": 1,
      "name": "Admin User"
    },
    "products": [
      {
        "id": 10,
        "product_id": 5,
        "variant_id": 12,
        "product": {
          "id": 5,
          "name": "Sản phẩm chính A",
          "image": "https://example.com/image.jpg",
          "has_variants": true,
          "price": 300000,
          "stock": 50
        },
        "variant": {
          "id": 12,
          "sku": "SKU-001",
          "option1_value": "500ml",
          "price": 300000,
          "stock": 50
        },
        "status": "1",
        "status_text": "Kích hoạt"
      }
    ],
    "sale_products": [
      {
        "id": 20,
        "product_id": 8,
        "variant_id": 15,
        "product": {
          "id": 8,
          "name": "Sản phẩm khuyến mãi B",
          "image": "https://example.com/image2.jpg",
          "has_variants": true,
          "price": 200000,
          "stock": 30
        },
        "variant": {
          "id": 15,
          "sku": "SKU-002",
          "option1_value": "250ml",
          "price": 200000,
          "stock": 30
        },
        "deal_price": 150000,
        "original_price": 200000,
        "savings_amount": 50000,
        "qty": 2,
        "status": "1",
        "status_text": "Kích hoạt"
      }
    ],
    "created_at": "2024-01-01T00:00:00.000000Z",
    "updated_at": "2024-01-15T10:30:00.000000Z"
  }
}
```

**Trạng thái:** Hoàn thành

---

### 3. POST /admin/api/deals

**Mục tiêu:** 创建新Deal

**Tham số đầu vào (Body JSON):**
```json
{
  "name": "Deal sốc tháng 2",
  "start": "2024-02-01T00:00:00",
  "end": "2024-02-29T23:59:59",
  "status": "1",
  "limited": 3,
  "products": [
    {
      "product_id": 5,
      "variant_id": 12,
      "status": "1"
    },
    {
      "product_id": 6,
      "variant_id": null,
      "status": "1"
    }
  ],
  "sale_products": [
    {
      "product_id": 8,
      "variant_id": 15,
      "price": 150000,
      "qty": 2,
      "status": "1"
    }
  ]
}
```

**Validation Rules:**
- `name`: required|string|max:255
- `start`: required|date
- `end`: required|date|after:start
- `status`: required|in:0,1
- `limited`: required|integer|min:1
- `products.*.product_id`: required|exists:posts,id
- `products.*.variant_id`: nullable|exists:variants,id
- `products.*.status`: required|in:0,1
- `sale_products.*.product_id`: required|exists:posts,id
- `sale_products.*.variant_id`: nullable|exists:variants,id
- `sale_products.*.price`: required|numeric|min:0
- `sale_products.*.qty`: required|integer|min:1
- `sale_products.*.status`: required|in:0,1

**Custom Validation:**
- Nếu sản phẩm có `has_variants = 1`, thì `variant_id` bắt buộc phải có
- Nếu sản phẩm có `has_variants = 0`, thì `variant_id` phải là NULL
- `variant_id` phải thuộc về `product_id` tương ứng

**Stock Validation (新增):**
- 所有产品的库存必须 > 0 才能参与 Deal
- 验证 `products` 和 `sale_products` 数组中的所有产品
- 有 variant 的产品：从 warehouse 系统获取实际库存
- 无 variant 的产品：使用 product.stock 字段或默认 variant 的库存
- 如果产品库存为 0，返回 422 错误

**Phản hồi mẫu (201):**
```json
{
  "success": true,
  "message": "Tạo Deal thành công",
  "data": {
    "id": 1,
    "name": "Deal sốc tháng 2",
    ...
  }
}
```

**Phản hồi lỗi (409 - Conflict):**
```json
{
  "success": false,
  "message": "Một số sản phẩm đã thuộc Deal khác đang hoạt động",
  "conflicts": [
    {
      "product_id": 5,
      "variant_id": 12,
      "conflict_deal_id": 3
    }
  ]
}
```

**Phản hồi lỗi (422 - Stock Validation):**
```json
{
  "success": false,
  "message": "Một số sản phẩm không có tồn kho, không thể tham gia Deal",
  "errors": {
    "products.0.stock": ["Tồn kho phải lớn hơn 0"],
    "products.1.stock": ["Tồn kho phải lớn hơn 0"]
  }
}
```

**Trạng thái:** Hoàn thành

---

### 4. PUT /admin/api/deals/{id}

**Mục tiêu:** 更新Deal信息

**Tham số đầu vào:** Tương tự POST, nhưng tất cả fields đều optional (sử dụng `sometimes`)

**Stock Validation (新增):**
- 更新产品时，所有产品的库存必须 > 0
- 如果产品库存为 0，返回 422 错误

**Phản hồi mẫu (200):**
```json
{
  "success": true,
  "message": "Cập nhật Deal thành công",
  "data": {
    "id": 1,
    ...
  }
}
```

**Trạng thái:** Hoàn thành

---

### 5. DELETE /admin/api/deals/{id}

**Mục tiêu:** 删除Deal

**Phản hồi mẫu (200):**
```json
{
  "success": true,
  "message": "Xóa Deal thành công"
}
```

**Trạng thái:** Hoàn thành

---

### 6. PATCH /admin/api/deals/{id}/status

**Mục tiêu:** 更新Deal状态

**Tham số đầu vào (Body JSON):**
```json
{
  "status": "1"
}
```

**Phản hồi mẫu (200):**
```json
{
  "success": true,
  "message": "Cập nhật trạng thái thành công",
  "data": {
    "id": 1,
    "status": "1",
    "status_text": "Kích hoạt",
    ...
  }
}
```

**Trạng thái:** Hoàn thành

---

## Recent Updates & Bug Fixes

### 2025-01-18

#### 1. Top Selling Products API - Logic Improvement
- **Updated:** `GET /api/products/top-selling`
- **Change:** Tính toán dựa trên tất cả đơn hàng (trừ đơn hàng đã hủy `status = 4`) thay vì chỉ đơn hàng đã hoàn thành
- **Added Fields:** `total_sold`, `total_sold_month` trong response
- **Files Updated:**
  - `app/Http/Controllers/Api/ProductController.php` - Method `getTopSelling()`
  - Added method `getTotalSoldThisMonth()`

#### 2. Route Parameter Fix - GHTK Print
- **Issue:** Missing required parameter for route `ghtk.print`
- **Root Cause:** Route định nghĩa parameter `{label}` nhưng code đang truyền `id`
- **Fixed Files:**
  - `app/Modules/Order/Views/index.blade.php` (line 223)
  - `app/Modules/Order/Views/view.blade.php` (line 204)
  - `app/Modules/Delivery/Views/ghtk/index.blade.php` (line 88)
- **Change:** Đổi từ `route('ghtk.print',['id' => $label_id])` sang `route('ghtk.print',['label' => $label_id])`
- **Status:** ✅ Fixed

---

### 2025-01-18 (Continued)

#### 3. Deal Management API - New Implementation
- **Added:** Complete Deal Management API với hỗ trợ variants
- **Endpoints:**
  - `GET /admin/api/deals` - Danh sách Deal
  - `GET /admin/api/deals/{id}` - Chi tiết Deal
  - `POST /admin/api/deals` - Tạo Deal
  - `PUT /admin/api/deals/{id}` - Cập nhật Deal
  - `DELETE /admin/api/deals/{id}` - Xóa Deal
  - `PATCH /admin/api/deals/{id}/status` - Cập nhật trạng thái
- **Features:**
  - Hỗ trợ variants cho cả sản phẩm chính và sản phẩm mua kèm
  - Validation tự động kiểm tra variant thuộc về product
  - Kiểm tra xung đột Deal dựa trên cặp (product_id, variant_id)
  - Tính toán số tiền tiết kiệm tự động
- **Files Created:**
  - `app/Modules/ApiAdmin/Controllers/DealController.php`
  - `app/Http/Resources/Deal/DealResource.php`
  - `app/Http/Resources/Deal/DealDetailResource.php`
  - `app/Http/Resources/Deal/ProductDealResource.php`
  - `app/Http/Resources/Deal/SaleDealResource.php`
  - `database/migrations/2026_01_18_172527_add_variant_id_to_deal_products_and_deal_sales_tables.php`
- **Files Updated:**
  - `app/Modules/Deal/Models/ProductDeal.php` - Thêm relationship với Variant
  - `app/Modules/Deal/Models/SaleDeal.php` - Thêm relationship với Variant
  - `app/Modules/ApiAdmin/routes.php` - Đăng ký Deal routes
- **Status:** ✅ Completed

---

## Warehouse Management API (V1)

### Overview
Module Quản lý Kho hàng đã được nâng cấp sang RESTful API V1 với đầy đủ các chức năng quản lý tồn kho, phiếu nhập/xuất hàng và thống kê.

**Base URL:** `/admin/api/v1/warehouse`

**Xem chi tiết:** Xem file `WAREHOUSE_API_CONVERSION_PLAN.md` để biết đầy đủ thông tin về các endpoints.

---

### A. Inventory Management (Quản lý Tồn kho)

#### 1. GET /admin/api/v1/warehouse/inventory
**Mục tiêu:** Lấy danh sách tồn kho với phân trang và bộ lọc

**Tham số đầu vào (Query Params):**
- `page` (integer, optional): Trang hiện tại, mặc định 1
- `limit` (integer, optional): Số lượng mỗi trang, mặc định 10, tối đa 100
- `keyword` (string, optional): Tìm kiếm theo tên sản phẩm hoặc SKU
- `variant_id` (integer, optional): Lọc theo variant ID
- `product_id` (integer, optional): Lọc theo product ID
- `min_stock` (integer, optional): Lọc tồn kho tối thiểu
- `max_stock` (integer, optional): Lọc tồn kho tối đa
- `sort_by` (string, optional): Sắp xếp theo (stock, product_name, variant_name), mặc định 'product_name'
- `sort_order` (string, optional): Thứ tự sắp xếp (asc, desc), mặc định 'asc'

**Phản hồi mẫu (200):**
```json
{
  "success": true,
  "data": [
    {
      "variant_id": 1,
      "variant_sku": "SKU-001",
      "variant_option": "500ml",
      "product_id": 10,
      "product_name": "Sản phẩm A",
      "product_image": "https://example.com/image.jpg",
      "import_total": 1000,
      "export_total": 750,
      "current_stock": 250,
      "last_import_date": "2026-01-18T10:30:00.000000Z",
      "last_export_date": "2026-01-19T14:20:00.000000Z"
    }
  ],
  "pagination": {
    "current_page": 1,
    "per_page": 10,
    "total": 150,
    "last_page": 15
  }
}
```

**Trạng thái:** Hoàn thành

---

#### 2. GET /admin/api/v1/warehouse/inventory/{variantId}
**Mục tiêu:** Lấy chi tiết tồn kho của một variant cụ thể

**Tham số đầu vào:**
- `variantId` (integer, required): ID của variant (URL parameter)

**Trạng thái:** Hoàn thành

---

#### 2.1 GET /admin/api/v1/warehouse/inventory/by-product/{productId}
**Mục tiêu:** Lấy tồn kho theo sản phẩm, bao gồm tất cả variants và các chỉ số vật lý/khuyến mãi/khả dụng.

**Tham số đầu vào:**
- `productId` (integer, required): ID sản phẩm

**Phản hồi mẫu (200):**
```json
{
  "success": true,
  "data": [
    {
      "variant_id": 12,
      "variant_sku": "SKU-001",
      "variant_option": "500ml",
      "product_id": 5,
      "product_name": "Serum X",
      "product_image": "https://cdn.example.com/p.jpg",
      "physical_stock": 120,
      "flash_sale_stock": 30,
      "deal_stock": 10,
      "available_stock": 80
    }
  ]
}
```

**Trạng thái:** Hoàn thành

---

### B. Import Receipts Management (Quản lý Phiếu Nhập hàng)

#### 3. GET /admin/api/v1/warehouse/import-receipts
**Mục tiêu:** Lấy danh sách phiếu nhập hàng với phân trang và bộ lọc

**Tham số đầu vào (Query Params):**
- `page`, `limit`, `keyword`, `code`, `user_id`, `date_from`, `date_to`, `sort_by`, `sort_order`

**Trạng thái:** Hoàn thành

---

#### 4. GET /admin/api/v1/warehouse/import-receipts/{id}
**Mục tiêu:** Lấy chi tiết phiếu nhập hàng bao gồm danh sách sản phẩm

**Trạng thái:** Hoàn thành

---

#### 5. POST /admin/api/v1/warehouse/import-receipts
**Mục tiêu:** Tạo phiếu nhập hàng mới

**Tham số đầu vào (Body - JSON):**
```json
{
  "code": "NH-ORDER001-1705564800",
  "subject": "Nhập hàng từ nhà cung cấp ABC",
  "content": "Ghi chú nhập hàng",
  "vat_invoice": "VAT-2026-001",
  "items": [
    {
      "variant_id": 10,
      "price": 100000,
      "quantity": 20
    }
  ]
}
```

**Validation Logic:**
- `code`: required, unique:warehouse,code
- `subject`: required, max:255
- `items`: required, array, min:1
- `items.*.variant_id`: required, exists:variants,id
- `items.*.price`: required, numeric, min:0
- `items.*.quantity`: required, integer, min:1

**Trạng thái:** Hoàn thành

**Note (Admin UI):**
- The page `/admin/import-goods/create` submits to this endpoint and expects JSON response with `data.view_url` for redirect.

**Ghi chú nâng cấp (2026-01-21):**
- Sau khi tạo phiếu nhập, hệ thống cộng `physical_stock` cho từng dòng `variant_id` và đồng bộ `available_stock = physical_stock - flash_sale_stock - deal_stock` để phục vụ truy vấn nhanh.

---

#### 6. PUT /admin/api/v1/warehouse/import-receipts/{id}
**Mục tiêu:** Cập nhật phiếu nhập hàng

**Trạng thái:** Hoàn thành

---

#### 7. DELETE /admin/api/v1/warehouse/import-receipts/{id}
**Mục tiêu:** Xóa phiếu nhập hàng

**Trạng thái:** Hoàn thành

---

#### 8. GET /admin/api/v1/warehouse/import-receipts/{id}/print
**Mục tiêu:** Lấy thông tin phiếu nhập hàng để in (bao gồm QR code, mã phiếu, tổng bằng chữ)

**Trạng thái:** Hoàn thành

---

### C. Export Receipts Management (Quản lý Phiếu Xuất hàng)

#### 9. GET /admin/api/v1/warehouse/export-receipts
**Mục tiêu:** Lấy danh sách phiếu xuất hàng với phân trang và bộ lọc

**Trạng thái:** Hoàn thành

---

#### 10. GET /admin/api/v1/warehouse/export-receipts/{id}
**Mục tiêu:** Lấy chi tiết phiếu xuất hàng

**Trạng thái:** Hoàn thành

---

#### 11. POST /admin/api/v1/warehouse/export-receipts
**Mục tiêu:** Tạo phiếu xuất hàng mới

**Validation Logic:** Tương tự import-receipts, nhưng thêm kiểm tra tồn kho

**Lỗi khi thiếu tồn kho (422):**
```json
{
  "success": false,
  "message": "Không đủ tồn kho để xuất hàng",
  "errors": {
    "items.0.quantity": [
      "Số lượng vượt quá tồn kho. Tồn kho hiện tại: 10"
    ]
  }
}
```

**Trạng thái:** Hoàn thành

---

#### 12. PUT /admin/api/v1/warehouse/export-receipts/{id}
**Mục tiêu:** Cập nhật phiếu xuất hàng

**Trạng thái:** Hoàn thành

---

#### 13. DELETE /admin/api/v1/warehouse/export-receipts/{id}
**Mục tiêu:** Xóa phiếu xuất hàng

**Trạng thái:** Hoàn thành

---

#### 14. GET /admin/api/v1/warehouse/export-receipts/{id}/print
**Mục tiêu:** Lấy thông tin phiếu xuất hàng để in

**Trạng thái:** Hoàn thành

---

### D. Supporting Endpoints (Các Endpoint Hỗ trợ)

#### 15. GET /admin/api/v1/warehouse/products/search
**Mục tiêu:** Tìm kiếm sản phẩm để chọn khi tạo phiếu nhập/xuất

**Tham số đầu vào (Query Params):**
- `q` (string, required, min:2): Từ khóa tìm kiếm
- `limit` (integer, optional): Số lượng kết quả, mặc định 50, tối đa 100

**Trạng thái:** Hoàn thành

---

#### 16. GET /admin/api/v1/warehouse/products/{productId}/variants
**Mục tiêu:** Lấy danh sách phân loại để nhập/xuất kho. Nếu sản phẩm single (`has_variants = 0`) chưa có bản ghi variant, API tự tạo một variant mặc định (fallback) để đảm bảo nhập kho chạy được.

**Tham số đầu vào:**
- `productId` (int, required): ID sản phẩm (`posts.type = product`)

**Logic:**
- Kiểm tra sản phẩm tồn tại; 404 nếu không phải loại product.
- Lấy danh sách variants theo `product_id`, sort `option1_value`.
- Nếu `has_variants = 0` và không có variant: tạo variant fallback với `sku` = `SKU-{SLUG}` (upper) hoặc `PROD-{id}-DEFAULT`, `option1_value` = `option1_name` hoặc `Default`, copy `price/stock` nếu có, `position = 0`, `user_id = auth()->id()`.
- Stock ưu tiên cột mới trong `product_warehouse` (bản ghi mới nhất): `physical_stock`, `flash_sale_stock`, `deal_stock`; `current_stock = physical - flash_sale - deal`, min 0. Nếu chưa có cột mới: fallback `current_stock = import - export` (helper `countProduct`).
- Trả thêm `is_default = true` cho variant fallback.

**Phản hồi mẫu (200):**
```json
{
  "success": true,
  "data": [
    {
      "id": 10,
      "product_id": 5,
      "sku": "SKU-SAN-PHAM-A",
      "option1_value": "500ml",
      "physical_stock": 120,
      "flash_sale_stock": 30,
      "deal_stock": 10,
      "current_stock": 80,
      "is_default": false
    }
  ]
}
```

**Phản hồi lỗi (404):**
```json
{"success": false, "message": "Sản phẩm không tồn tại hoặc không phải loại product"}
```

**Trạng thái:** Hoàn thành (đã bổ sung fallback single product + stock chuẩn)

---

#### 17. GET /admin/api/v1/warehouse/variants/{variantId}/stock
**Mục tiêu:** Lấy thông tin tồn kho của một variant

**Trạng thái:** Hoàn thành

---

#### 18. GET /admin/api/v1/warehouse/variants/{variantId}/price
**Mục tiêu:** Lấy giá đề xuất cho variant (giá bán hoặc giá nhập gần nhất)

**Tham số đầu vào (Query Params):**
- `type` (string, optional): Loại giá (import|export), mặc định 'export'

**Trạng thái:** Hoàn thành

---

### E. Statistics (Thống kê)

#### 19. GET /admin/api/v1/warehouse/statistics/quantity
**Mục tiêu:** Thống kê số lượng tồn kho theo variant

**Trạng thái:** Hoàn thành

---

#### 20. GET /admin/api/v1/warehouse/statistics/revenue
**Mục tiêu:** Thống kê doanh thu theo variant

**Trạng thái:** Hoàn thành

---

#### 21. GET /admin/api/v1/warehouse/statistics/summary
**Mục tiêu:** Tổng hợp thống kê tổng quan kho hàng

**Tham số đầu vào (Query Params):**
- `date_from` (date, optional): Từ ngày (format: YYYY-MM-DD)
- `date_to` (date, optional): Đến ngày (format: YYYY-MM-DD)

**Trạng thái:** Hoàn thành

---

### Implementation Details

**Files Created:**
- `app/Services/Warehouse/WarehouseServiceInterface.php`
- `app/Services/Warehouse/WarehouseService.php`
- `app/Http/Requests/Warehouse/StoreImportReceiptRequest.php`
- `app/Http/Requests/Warehouse/UpdateImportReceiptRequest.php`
- `app/Http/Requests/Warehouse/StoreExportReceiptRequest.php`
- `app/Http/Requests/Warehouse/UpdateExportReceiptRequest.php`
- `app/Http/Resources/Warehouse/InventoryResource.php`
- `app/Http/Resources/Warehouse/ImportReceiptResource.php`
- `app/Http/Resources/Warehouse/ImportReceiptCollection.php`
- `app/Http/Resources/Warehouse/ExportReceiptResource.php`
- `app/Http/Resources/Warehouse/ExportReceiptCollection.php`
- `app/Http/Resources/Warehouse/ReceiptItemResource.php`
- `app/Modules/ApiAdmin/Controllers/WarehouseController.php`

**Files Updated:**
- `app/Modules/Warehouse/Models/Warehouse.php` - Thêm relationship `items()`
- `app/Modules/ApiAdmin/routes.php` - Đăng ký Warehouse routes
- `app/Providers/AppServiceProvider.php` - Đăng ký WarehouseService

**Features:**
- ✅ Đầy đủ CRUD cho Import/Export receipts
- ✅ Kiểm tra tồn kho tự động khi xuất hàng
- ✅ Hỗ trợ VAT invoice
- ✅ Tự động tạo mã phiếu nhập/xuất hàng
- ✅ QR code và tổng bằng chữ tiếng Việt
- ✅ Thống kê tồn kho, doanh thu, tổng hợp
- ✅ Tìm kiếm sản phẩm và lấy phân loại
- ✅ Validation đầy đủ với thông báo lỗi chi tiết

---

---

## Flash Sale Mixed Pricing API (Mua vượt hạn mức)

### 1. POST /api/price/calculate

**Mục tiêu:** Tính giá với số lượng (hỗ trợ giá hỗn hợp khi mua vượt hạn mức Flash Sale)

**Tham số đầu vào (Body - JSON):**
- `product_id` (integer, required): Product ID
- `variant_id` (integer, optional): Variant ID
- `quantity` (integer, required): Số lượng mua

**Logic:**
- Nếu `quantity ≤ flash_sale_remaining`: Tất cả tính theo giá Flash Sale
- Nếu `quantity > flash_sale_remaining`: 
  - Phần trong hạn mức tính theo giá Flash Sale
  - Phần vượt hạn mức tính theo giá ưu tiên tiếp theo (Promotion hoặc giá gốc)

**Phản hồi mẫu (200):**
```json
{
  "success": true,
  "data": {
    "total_price": 1500000,
    "price_breakdown": [
      {
        "type": "flashsale",
        "quantity": 5,
        "unit_price": 100000,
        "subtotal": 500000
      },
      {
        "type": "promotion",
        "quantity": 10,
        "unit_price": 100000,
        "subtotal": 1000000
      }
    ],
    "flash_sale_remaining": 5,
    "warning": "Chỉ còn 5 sản phẩm giá Flash Sale, 10 sản phẩm còn lại sẽ được tính theo giá khuyến mãi",
    "flash_sale_id": 1,
    "product_sale_id": 10
  }
}
```

**Trạng thái:** Hoàn thành

---

## Warehouse Management API V2 (Inventory Module)

### Overview
Module Quản lý Kho hàng V2 được xây dựng hoàn toàn mới với kiến trúc hiện đại, hỗ trợ:
- Quản lý tồn kho đa kho (multi-warehouse)
- Theo dõi biến động tồn kho chi tiết (stock movements)
- Giữ hàng cho Flash Sale và Deal Sốc
- Kiểm soát tồn kho vật lý vs khả dụng
- Báo cáo định giá tồn kho

**Base URL:** `/api/v2/inventory`

**Authentication:** Required (auth:api middleware)

---

### A. Stock Management (Quản lý Tồn kho)

#### 1. GET /api/v2/inventory/stocks

**Mục tiêu:** Lấy danh sách tồn kho với phân trang và bộ lọc realtime

**Tham số đầu vào (Query Params):**
- `warehouse_id` (integer, optional): Lọc theo kho, mặc định kho chính
- `keyword` (string, optional): Tìm theo SKU hoặc tên sản phẩm
- `low_stock_only` (boolean, optional): Chỉ lấy sản phẩm sắp hết hàng
- `out_of_stock_only` (boolean, optional): Chỉ lấy sản phẩm hết hàng
- `per_page` (integer, optional): Số lượng mỗi trang, mặc định 20

**Phản hồi mẫu (200):**
```json
{
  "success": true,
  "data": [
    {
      "id": 1,
      "warehouse_id": 1,
      "variant_id": 10,
      "physical_stock": 100,
      "reserved_stock": 20,
      "available_stock": 80,
      "flash_sale_hold": 10,
      "deal_hold": 5,
      "low_stock_threshold": 10,
      "reorder_point": 20,
      "average_cost": 150000,
      "last_cost": 160000,
      "location_code": "A1-B2-C3",
      "last_stock_check": "2026-01-20T10:00:00.000000Z",
      "last_movement_at": "2026-01-21T08:30:00.000000Z",
      "variant": {
        "id": 10,
        "sku": "SKU-001",
        "option1_value": "500ml",
        "price": 200000,
        "product": {
          "id": 5,
          "name": "Sản phẩm A",
          "image": "https://cdn.example.com/img.jpg"
        }
      },
      "warehouse": {
        "id": 1,
        "name": "Kho Hà Nội",
        "code": "HN01"
      }
    }
  ],
  "pagination": {
    "current_page": 1,
    "last_page": 5,
    "per_page": 20,
    "total": 100
  }
}
```

**Trạng thái:** Hoàn thành

---

#### 2. GET /api/v2/inventory/stocks/{variantId}

**Mục tiêu:** Lấy chi tiết tồn kho của một variant

**Tham số đầu vào:**
- `variantId` (integer, required): ID variant (URL parameter)
- `warehouse_id` (integer, optional, Query): ID kho, mặc định kho chính

**Phản hồi mẫu (200):**
```json
{
  "success": true,
  "data": {
    "variantId": 10,
    "warehouseId": 1,
    "physicalStock": 100,
    "reservedStock": 20,
    "availableStock": 80,
    "flashSaleHold": 10,
    "dealHold": 5,
    "sellableStock": 65,
    "lowStockThreshold": 10,
    "reorderPoint": 20,
    "averageCost": 150000,
    "lastCost": 160000,
    "locationCode": "A1-B2-C3"
  }
}
```

**Trạng thái:** Hoàn thành

---

#### 3. POST /api/v2/inventory/stocks/check-availability

**Mục tiêu:** Kiểm tra khả dụng của nhiều sản phẩm cùng lúc (batch check)

**Tham số đầu vào (Body - JSON):**
```json
{
  "warehouse_id": 1,
  "items": [
    {
      "variant_id": 10,
      "quantity": 5
    },
    {
      "variant_id": 15,
      "quantity": 3
    }
  ]
}
```

**Validation:**
- `items`: required|array
- `items.*.variant_id`: required|integer
- `items.*.quantity`: required|integer|min:1

**Phản hồi mẫu (200):**
```json
{
  "success": true,
  "data": [
    {
      "variant_id": 10,
      "requested": 5,
      "available": 80,
      "is_available": true
    },
    {
      "variant_id": 15,
      "requested": 3,
      "available": 2,
      "is_available": false
    }
  ],
  "all_available": false
}
```

**Trạng thái:** Hoàn thành

---

#### 4. GET /api/v2/inventory/stocks/low-stock

**Mục tiêu:** Lấy danh sách sản phẩm sắp hết hàng (dưới ngưỡng cảnh báo)

**Tham số đầu vào (Query Params):**
- `warehouse_id` (integer, optional): Lọc theo kho

**Phản hồi mẫu (200):**
```json
{
  "success": true,
  "data": [
    {
      "id": 1,
      "warehouse_id": 1,
      "variant_id": 10,
      "physical_stock": 8,
      "available_stock": 8,
      "low_stock_threshold": 10,
      "reorder_point": 20,
      "variant": {
        "id": 10,
        "sku": "SKU-001",
        "option1_value": "500ml",
        "product": {
          "id": 5,
          "name": "Sản phẩm A"
        }
      },
      "warehouse": {
        "id": 1,
        "name": "Kho Hà Nội"
      }
    }
  ]
}
```

**Trạng thái:** Hoàn thành

---

### B. Receipt Management (Quản lý Phiếu Nhập/Xuất/Chuyển kho)

#### 5. POST /api/v2/inventory/receipts/import

**Mục tiêu:** Tạo phiếu nhập kho mới

**Tham số đầu vào (Body - JSON):**
```json
{
  "code": "NH-2026-001",
  "subject": "Nhập hàng từ nhà cung cấp ABC",
  "warehouse_id": 1,
  "supplier_name": "Công ty ABC",
  "supplier_code": "NCC-001",
  "reference_number": "PO-2026-001",
  "notes": "Ghi chú nhập hàng",
  "items": [
    {
      "variant_id": 10,
      "quantity": 100,
      "unit_price": 150000,
      "batch_number": "BATCH-001",
      "manufacturing_date": "2026-01-01",
      "expiry_date": "2028-01-01",
      "condition": "new",
      "notes": "Hàng mới 100%"
    }
  ]
}
```

**Validation:**
- `code`: required|string
- `subject`: required|string
- `warehouse_id`: optional|exists:warehouses_v2,id
- `items`: required|array|min:1
- `items.*.variant_id`: required|integer|exists:variants,id
- `items.*.quantity`: required|integer|min:1
- `items.*.unit_price`: optional|numeric|min:0
- `items.*.condition`: optional|in:new,used,damaged,refurbished

**Logic xử lý:**
- Tự động tăng `physical_stock` và cập nhật `available_stock`
- Tính toán `average_cost` theo phương pháp bình quân gia quyền
- Ghi log vào bảng `stock_movements` với type = 'import'
- Tạo cảnh báo nếu cần

**Phản hồi mẫu (201):**
```json
{
  "success": true,
  "message": "Nhập kho thành công",
  "data": {
    "id": 123,
    "receipt_code": "NH-2026-001",
    "receipt_type": "import",
    "status": "completed",
    "warehouse_id": 1,
    "subject": "Nhập hàng từ nhà cung cấp ABC",
    "total_items": 1,
    "total_quantity": 100,
    "total_value": 15000000,
    "created_by": 1,
    "created_at": "2026-01-21T10:00:00.000000Z"
  }
}
```

**Phản hồi lỗi (422):**
```json
{
  "success": false,
  "message": "Mã phiếu đã tồn tại hoặc dữ liệu không hợp lệ"
}
```

**Trạng thái:** Hoàn thành

---

#### 6. POST /api/v2/inventory/receipts/export

**Mục tiêu:** Tạo phiếu xuất kho mới

**Tham số đầu vào (Body - JSON):**
```json
{
  "code": "XH-2026-001",
  "subject": "Xuất hàng bán lẻ",
  "warehouse_id": 1,
  "customer_name": "Nguyễn Văn A",
  "reference_type": "order",
  "reference_id": 456,
  "notes": "Ghi chú xuất hàng",
  "items": [
    {
      "variant_id": 10,
      "quantity": 5,
      "unit_price": 200000,
      "notes": "Xuất cho đơn hàng #456"
    }
  ]
}
```

**Validation:** Tương tự import, thêm kiểm tra tồn kho

**Logic xử lý:**
- Kiểm tra `available_stock >= quantity` trước khi xuất
- Tự động giảm `physical_stock` và cập nhật `available_stock`
- Ghi log vào `stock_movements` với type = 'export' hoặc 'sale'
- Trả lỗi 422 nếu không đủ tồn kho

**Phản hồi mẫu (201):**
```json
{
  "success": true,
  "message": "Xuất kho thành công",
  "data": {
    "id": 124,
    "receipt_code": "XH-2026-001",
    "receipt_type": "export",
    "status": "completed",
    "warehouse_id": 1,
    "subject": "Xuất hàng bán lẻ",
    "total_items": 1,
    "total_quantity": 5,
    "total_value": 1000000,
    "created_at": "2026-01-21T10:30:00.000000Z"
  }
}
```

**Phản hồi lỗi (422 - Không đủ tồn kho):**
```json
{
  "success": false,
  "message": "Không đủ tồn kho để xuất. Variant ID: 10, Yêu cầu: 5, Khả dụng: 3"
}
```

**Trạng thái:** Hoàn thành

---

#### 7. POST /api/v2/inventory/receipts/transfer

**Mục tiêu:** Chuyển kho giữa các kho

**Tham số đầu vào (Body - JSON):**
```json
{
  "from_warehouse_id": 1,
  "to_warehouse_id": 2,
  "code": "CK-2026-001",
  "subject": "Chuyển hàng từ Hà Nội sang TP.HCM",
  "items": [
    {
      "variant_id": 10,
      "quantity": 20
    }
  ]
}
```

**Validation:**
- `from_warehouse_id`: required|integer|exists:warehouses_v2,id
- `to_warehouse_id`: required|integer|exists:warehouses_v2,id|different:from_warehouse_id
- `items`: required|array|min:1

**Logic xử lý:**
- Giảm tồn kho từ `from_warehouse_id`
- Tăng tồn kho vào `to_warehouse_id`
- Ghi 2 log movements: 'transfer_out' và 'transfer_in'
- Sử dụng DB transaction để đảm bảo tính toàn vẹn

**Phản hồi mẫu (201):**
```json
{
  "success": true,
  "data": {
    "id": 125,
    "receipt_code": "CK-2026-001",
    "receipt_type": "transfer",
    "status": "completed",
    "from_warehouse_id": 1,
    "to_warehouse_id": 2,
    "subject": "Chuyển hàng từ Hà Nội sang TP.HCM",
    "total_items": 1,
    "total_quantity": 20
  }
}
```

**Trạng thái:** Hoàn thành

---

#### 8. POST /api/v2/inventory/receipts/adjust

**Mục tiêu:** Điều chỉnh tồn kho (kiểm kê, hao hụt, thừa...)

**Tham số đầu vào (Body - JSON):**
```json
{
  "code": "DC-2026-001",
  "subject": "Điều chỉnh tồn kho sau kiểm kê",
  "warehouse_id": 1,
  "reason": "Phát hiện hàng hư hỏng",
  "items": [
    {
      "variant_id": 10,
      "new_quantity": 95,
      "reason": "Phát hiện 5 sản phẩm bị hư hỏng"
    }
  ]
}
```

**Validation:**
- `items.*.new_quantity`: required|integer|min:0

**Logic xử lý:**
- So sánh `new_quantity` với `physical_stock` hiện tại
- Nếu tăng: ghi log 'adjustment_plus'
- Nếu giảm: ghi log 'adjustment_minus'
- Cập nhật `physical_stock` = `new_quantity`

**Phản hồi mẫu (201):**
```json
{
  "success": true,
  "data": {
    "id": 126,
    "receipt_code": "DC-2026-001",
    "receipt_type": "adjustment",
    "status": "completed",
    "warehouse_id": 1,
    "subject": "Điều chỉnh tồn kho sau kiểm kê",
    "adjustments": [
      {
        "variant_id": 10,
        "old_quantity": 100,
        "new_quantity": 95,
        "difference": -5,
        "reason": "Phát hiện 5 sản phẩm bị hư hỏng"
      }
    ]
  }
}
```

**Trạng thái:** Hoàn thành

---

#### 9. GET /api/v2/inventory/receipts

**Mục tiêu:** Lấy danh sách phiếu nhập/xuất/chuyển kho

**Tham số đầu vào (Query Params):**
- `type` (string, optional): Lọc theo loại (import|export|transfer|adjustment)
- `status` (string, optional): Lọc theo trạng thái (draft|pending|completed|cancelled)
- `keyword` (string, optional): Tìm theo mã phiếu hoặc subject
- `per_page` (integer, optional): Số lượng mỗi trang, mặc định 20

**Phản hồi mẫu (200):**
```json
{
  "success": true,
  "data": [
    {
      "id": 123,
      "receipt_code": "NH-2026-001",
      "receipt_type": "import",
      "status": "completed",
      "subject": "Nhập hàng từ nhà cung cấp ABC",
      "warehouse_id": 1,
      "total_items": 3,
      "total_quantity": 150,
      "total_value": 20000000,
      "creator": {
        "id": 1,
        "name": "Admin User"
      },
      "created_at": "2026-01-21T10:00:00.000000Z"
    }
  ],
  "pagination": {
    "current_page": 1,
    "last_page": 10,
    "total": 200
  }
}
```

**Trạng thái:** Hoàn thành

---

#### 10. GET /api/v2/inventory/receipts/{id}

**Mục tiêu:** Lấy chi tiết phiếu nhập/xuất/chuyển kho

**Phản hồi mẫu (200):**
```json
{
  "success": true,
  "data": {
    "id": 123,
    "receipt_code": "NH-2026-001",
    "receipt_type": "import",
    "status": "completed",
    "subject": "Nhập hàng từ nhà cung cấp ABC",
    "warehouse_id": 1,
    "supplier_name": "Công ty ABC",
    "supplier_code": "NCC-001",
    "reference_number": "PO-2026-001",
    "notes": "Ghi chú nhập hàng",
    "total_items": 1,
    "total_quantity": 100,
    "total_value": 15000000,
    "items": [
      {
        "id": 1,
        "variant_id": 10,
        "quantity": 100,
        "unit_price": 150000,
        "total_price": 15000000,
        "stock_before": 50,
        "stock_after": 150,
        "batch_number": "BATCH-001",
        "manufacturing_date": "2026-01-01",
        "expiry_date": "2028-01-01",
        "condition": "new",
        "notes": "Hàng mới 100%",
        "variant": {
          "id": 10,
          "sku": "SKU-001",
          "option1_value": "500ml",
          "product": {
            "id": 5,
            "name": "Sản phẩm A",
            "image": "https://cdn.example.com/img.jpg"
          }
        }
      }
    ],
    "creator": {
      "id": 1,
      "name": "Admin User"
    },
    "from_warehouse": null,
    "to_warehouse": {
      "id": 1,
      "name": "Kho Hà Nội",
      "code": "HN01"
    },
    "created_at": "2026-01-21T10:00:00.000000Z",
    "updated_at": "2026-01-21T10:00:00.000000Z"
  }
}
```

**Trạng thái:** Hoàn thành

---

#### 11. DELETE /api/v2/inventory/receipts/{id}

**Mục tiêu:** Xóa phiếu (chỉ xóa được phiếu ở trạng thái draft hoặc pending)

**Phản hồi mẫu (200):**
```json
{
  "success": true,
  "message": "Đã xóa phiếu"
}
```

**Phản hồi lỗi (422):**
```json
{
  "success": false,
  "message": "Chỉ có thể xóa phiếu ở trạng thái nháp hoặc chờ duyệt"
}
```

**Trạng thái:** Hoàn thành

---

### C. Warehouse Management (Quản lý Kho)

#### 12. GET /api/v2/inventory/warehouses

**Mục tiêu:** Lấy danh sách kho đang hoạt động

**Phản hồi mẫu (200):**
```json
{
  "success": true,
  "data": [
    {
      "id": 1,
      "code": "HN01",
      "name": "Kho Hà Nội",
      "address": "123 Đường ABC, Hà Nội",
      "phone": "0123456789",
      "email": "kho.hn@example.com",
      "manager_name": "Nguyễn Văn A",
      "is_default": true,
      "is_active": true,
      "capacity": 10000,
      "current_stock_value": 500000000,
      "created_at": "2026-01-01T00:00:00.000000Z"
    },
    {
      "id": 2,
      "code": "HCM01",
      "name": "Kho TP. Hồ Chí Minh",
      "address": "456 Đường XYZ, TP.HCM",
      "is_default": false,
      "is_active": true
    }
  ]
}
```

**Trạng thái:** Hoàn thành

---

### D. Movement History & Reports (Lịch sử biến động & Báo cáo)

#### 13. GET /api/v2/inventory/movements

**Mục tiêu:** Lấy lịch sử biến động tồn kho của một variant

**Tham số đầu vào (Query Params):**
- `variant_id` (integer, required): ID variant
- `warehouse_id` (integer, optional): Lọc theo kho
- `limit` (integer, optional): Số lượng bản ghi, mặc định 50

**Phản hồi mẫu (200):**
```json
{
  "success": true,
  "data": [
    {
      "id": 1,
      "warehouse_id": 1,
      "variant_id": 10,
      "movement_type": "import",
      "quantity": 100,
      "physical_before": 50,
      "physical_after": 150,
      "reserved_before": 10,
      "reserved_after": 10,
      "available_before": 40,
      "available_after": 140,
      "reference_type": "receipt",
      "reference_id": 123,
      "reference_code": "NH-2026-001",
      "reason": "Nhập hàng từ nhà cung cấp ABC",
      "unit_cost": 150000,
      "total_cost": 15000000,
      "created_by": 1,
      "created_at": "2026-01-21T10:00:00.000000Z"
    },
    {
      "id": 2,
      "warehouse_id": 1,
      "variant_id": 10,
      "movement_type": "sale",
      "quantity": -5,
      "physical_before": 150,
      "physical_after": 145,
      "available_before": 140,
      "available_after": 135,
      "reference_type": "order",
      "reference_id": 456,
      "reference_code": "ORD-456",
      "reason": "Xuất hàng cho đơn hàng #456",
      "created_at": "2026-01-21T11:00:00.000000Z"
    }
  ]
}
```

**Các loại movement_type:**
- `import`: Nhập kho
- `export`: Xuất kho
- `sale`: Bán hàng
- `sale_cancel`: Hủy đơn hàng (hoàn lại kho)
- `return`: Trả hàng (nhập lại kho)
- `transfer_out`: Chuyển kho đi
- `transfer_in`: Chuyển kho đến
- `adjustment_plus`: Điều chỉnh tăng
- `adjustment_minus`: Điều chỉnh giảm
- `reserve`: Giữ hàng
- `release`: Thả hàng giữ
- `flash_sale_hold`: Giữ cho Flash Sale
- `flash_sale_release`: Thả Flash Sale
- `deal_hold`: Giữ cho Deal
- `deal_release`: Thả Deal
- `damage`: Hư hỏng
- `lost`: Thất thoát
- `found`: Tìm thấy hàng thừa
- `initial`: Khởi tạo ban đầu

**Trạng thái:** Hoàn thành

---

#### 14. GET /api/v2/inventory/reports/valuation

**Mục tiêu:** Báo cáo định giá tồn kho (tổng giá trị hàng tồn kho)

**Tham số đầu vào (Query Params):**
- `warehouse_id` (integer, optional): Lọc theo kho, không truyền sẽ lấy tất cả kho

**Phản hồi mẫu (200):**
```json
{
  "success": true,
  "data": {
    "total_value": 500000000,
    "total_items": 150,
    "total_quantity": 5000,
    "by_warehouse": [
      {
        "warehouse_id": 1,
        "warehouse_name": "Kho Hà Nội",
        "total_value": 300000000,
        "total_items": 100,
        "total_quantity": 3000
      },
      {
        "warehouse_id": 2,
        "warehouse_name": "Kho TP.HCM",
        "total_value": 200000000,
        "total_items": 50,
        "total_quantity": 2000
      }
    ],
    "top_value_products": [
      {
        "variant_id": 10,
        "product_name": "Sản phẩm A",
        "sku": "SKU-001",
        "quantity": 500,
        "average_cost": 150000,
        "total_value": 75000000
      }
    ],
    "generated_at": "2026-01-21T12:00:00.000000Z"
  }
}
```

**Trạng thái:** Hoàn thành

---

### E. Implementation Details

**Files Created:**
- `app/Services/Inventory/InventoryService.php` - Service chính
- `app/Services/Inventory/Contracts/InventoryServiceInterface.php` - Interface
- `app/Services/Inventory/DTOs/` - Thư mục chứa các DTO classes
  - `StockDTO.php`
  - `ImportStockDTO.php`
  - `ExportStockDTO.php`
  - `TransferStockDTO.php`
  - `AdjustStockDTO.php`
  - `ReserveStockDTO.php`
- `app/Models/` - Eloquent Models
  - `InventoryStock.php`
  - `StockReceipt.php`
  - `StockReceiptItem.php`
  - `StockMovement.php`
  - `StockReservation.php`
  - `StockAlert.php`
  - `WarehouseV2.php`
- `app/Http/Controllers/Api/V2/InventoryController.php`
- `routes/api_inventory.php`
- `config/inventory.php` - Cấu hình module
- `app/Providers/InventoryServiceProvider.php`

**Database Tables:**
- `warehouses_v2` - Danh sách kho
- `inventory_stocks` - Tồn kho theo variant và kho
- `stock_receipts` - Phiếu nhập/xuất/chuyển kho
- `stock_receipt_items` - Chi tiết phiếu
- `stock_movements` - Lịch sử biến động tồn kho
- `stock_reservations` - Giữ hàng cho đơn hàng/Flash Sale/Deal
- `stock_alerts` - Cảnh báo tồn kho

**Key Features:**
- ✅ Multi-warehouse support (hỗ trợ đa kho)
- ✅ Physical stock vs Available stock tracking
- ✅ Flash Sale & Deal stock holding
- ✅ Detailed stock movement logging
- ✅ Average cost calculation (AVCO method)
- ✅ Low stock & out of stock alerts
- ✅ Batch availability checking
- ✅ Stock transfer between warehouses
- ✅ Stock adjustment (inventory count)
- ✅ Inventory valuation reports
- ✅ Cache support for performance
- ✅ Database transaction for data integrity

**Differences from V1:**
- V1 sử dụng bảng `warehouse` và `product_warehouse` (cũ)
- V2 sử dụng kiến trúc mới với 7 bảng riêng biệt
- V2 hỗ trợ đa kho, V1 chỉ có 1 kho duy nhất
- V2 có theo dõi chi tiết biến động tồn kho (stock movements)
- V2 có hệ thống giữ hàng cho Flash Sale/Deal
- V2 có cảnh báo tồn kho tự động
- V2 có báo cáo định giá tồn kho

**Migration từ V1 sang V2:**
- Sử dụng command: `php artisan inventory:migrate-legacy-data`
- Dữ liệu cũ từ bảng `warehouse` và `product_warehouse` sẽ được migrate sang các bảng V2
- Sau khi migrate, nên kiểm tra và xác nhận dữ liệu trước khi xóa module cũ

---

---

## Warehouse Accounting V2 (Nhập/Xuất hàng - Giao diện A4)

### Overview
Module Nhập/Xuất hàng V2 với giao diện form A4 chuẩn kế toán, hỗ trợ tạo phiếu nhập/xuất hàng trực tiếp từ giao diện web.

**Base URL:** `/admin/warehouse/accounting`

**Authentication:** Required (web middleware + auth)

---

### 1. GET /admin/warehouse/accounting

**Mục tiêu:** Hiển thị form tạo phiếu nhập/xuất hàng (A4 format)

**Query Params:**
- `id` (integer, optional): ID phiếu để chỉnh sửa

**Features:**
- Form A4 chuẩn kế toán
- Tự động sinh mã phiếu: `[PN/PX] + [yymmdd] + [4 ký tự hash]`
- Search sản phẩm bằng Select2 Ajax inline
- Tự động load variants sau khi chọn sản phẩm
- Tự động tính thành tiền = Số lượng * Đơn giá
- QR Code tự động sinh dựa trên mã phiếu
- Layout in ấn chuẩn A4

**Trạng thái:** Hoàn thành

---

### 2. POST /admin/warehouse/accounting

**Mục tiêu:** Lưu phiếu nhập/xuất hàng

**Body (JSON):**
```json
{
  "type": "import",
  "receipt_code": "PN250121ABCD",
  "subject": "Nhập hàng từ nhà cung cấp ABC",
  "content": "Ghi chú",
  "vat_invoice": "VAT-2026-001",
  "supplier_name": "Công ty ABC",
  "customer_name": "Khách hàng XYZ",
  "status": "draft",
  "items": [
    {
      "variant_id": 10,
      "quantity": 20,
      "unit_price": 100000,
      "notes": ""
    }
  ]
}
```

**Validation:**
- `type`: required, in:import,export
- `receipt_code`: optional, unique:stock_receipts,receipt_code
- `subject`: required, string, max:255
- `items`: required, array, min:1
- `items.*.variant_id`: required, exists:variants,id
- `items.*.quantity`: required, integer, min:1
- `items.*.unit_price`: required, numeric, min:0

**Logic xử lý:**
- Tạo bản ghi `stock_receipts` với status = draft
- Tạo các bản ghi `stock_receipt_items`
- Tính tổng: total_items, total_quantity, total_value
- Nếu status = completed, tự động cập nhật tồn kho

**Phản hồi mẫu (201):**
```json
{
  "success": true,
  "message": "Lưu phiếu thành công",
  "data": {
    "id": 123,
    "receipt_code": "PN250121ABCD",
    "view_url": "/admin/warehouse/accounting?id=123"
  }
}
```

**Trạng thái:** Hoàn thành

---

### 3. POST /admin/warehouse/accounting/{id}/complete

**Mục tiêu:** Hoàn thành phiếu (cập nhật tồn kho)

**Logic xử lý:**
- Chỉ có thể complete khi status = draft hoặc approved
- Validate tồn kho (nếu là export)
- Gọi `InventoryService::importStock()` hoặc `exportStock()`
- Cập nhật `stock_before` và `stock_after` trong items
- Chuyển status sang `completed`

**Phản hồi mẫu (200):**
```json
{
  "success": true,
  "message": "Hoàn thành phiếu thành công",
  "data": {
    "id": 123,
    "status": "completed"
  }
}
```

**Phản hồi lỗi (422):**
```json
{
  "success": false,
  "message": "Không đủ tồn kho cho variant SKU-001. Yêu cầu: 5, Có sẵn: 3"
}
```

**Trạng thái:** Hoàn thành

---

### Implementation Details

**Files Created:**
- `app/Services/Warehouse/StockReceiptService.php` - Service xử lý business logic
- `app/Modules/Warehouse/Controllers/WarehouseAccountingController.php` - Controller
- `app/Modules/Warehouse/Views/accounting.blade.php` - View form A4
- `public/admin/css/warehouse-accounting.css` - CSS riêng cho module

**Files Updated:**
- `app/Modules/Warehouse/routes.php` - Đăng ký routes
- `app/Modules/Layout/Views/sidebar.blade.php` - Thêm menu "Nhập/Xuất hàng"
- `app/Providers/AppServiceProvider.php` - Đăng ký StockReceiptService

**Key Features:**
- ✅ Form A4 chuẩn kế toán
- ✅ Tự động sinh mã phiếu
- ✅ Search sản phẩm inline với Select2 Ajax
- ✅ Tự động load variants và giá
- ✅ Tự động tính thành tiền
- ✅ QR Code tự động
- ✅ Layout in ấn chuẩn A4
- ✅ Cập nhật tồn kho khi complete
- ✅ CSS tách biệt, chỉ load khi cần

**Trạng thái:** Hoàn thành

---

---

## Warehouse Accounting API (V2)

### Overview
API V2 cho module Warehouse Accounting, quản lý phiếu nhập/xuất kho với chuẩn kế toán 02-VT.

**Base URL:** `/admin/api/v2/warehouse/accounting`

---

### 1. List Stock Receipts

**Endpoint:** `GET /admin/api/v2/warehouse/accounting/receipts`

**Mục tiêu:** Lấy danh sách phiếu nhập/xuất kho với phân trang và bộ lọc

**Tham số Query:**
- `type` (optional): `import` hoặc `export`
- `status` (optional): `draft`, `pending`, `approved`, `completed`, `cancelled`
- `date_from` (optional): Ngày bắt đầu (format: Y-m-d)
- `date_to` (optional): Ngày kết thúc (format: Y-m-d)
- `receipt_code` (optional): Mã phiếu
- `partner_name` (optional): Tên đối tác
- `search` (optional): Tìm kiếm theo mã phiếu hoặc tên đối tác
- `per_page` (optional): Số lượng mỗi trang (default: 15)
- `page` (optional): Số trang (default: 1)

**Phản hồi mẫu (200):**
```json
{
  "success": true,
  "data": [
    {
      "id": 1,
      "receipt_code": "PN260123ABCD",
      "type": "import",
      "type_label": "Nhập kho",
      "status": "completed",
      "status_label": "Hoàn thành",
      "total_value": 1000000,
      "total_value_formatted": "1.000.000 đ",
      "created_at": "2026-01-23 10:30:00",
      "created_at_formatted": "23/01/2026 10:30",
      "supplier_name": "Công ty ABC",
      "supplier_phone": "0123456789",
      "creator": {
        "id": 1,
        "name": "Admin"
      }
    }
  ],
  "pagination": {
    "current_page": 1,
    "last_page": 5,
    "per_page": 15,
    "total": 75
  }
}
```

**Trạng thái:** Hoàn thành

---

### 2. Get Single Receipt

**Endpoint:** `GET /admin/api/v2/warehouse/accounting/receipts/{id}`

**Mục tiêu:** Lấy thông tin chi tiết một phiếu

**Tham số URL:**
- `id` (required): ID của phiếu

**Phản hồi mẫu (200):**
```json
{
  "success": true,
  "data": {
    "id": 1,
    "receipt_code": "PN260123ABCD",
    "type": "import",
    "type_label": "Nhập kho",
    "status": "completed",
    "status_label": "Hoàn thành",
    "supplier_name": "Công ty ABC",
    "supplier_phone": "0123456789",
    "supplier_address": "123 Đường ABC",
    "supplier_tax_id": "0123456789",
    "subject": "Nhập hàng tháng 1",
    "vat_invoice": "VAT001",
    "total_value": 1000000,
    "total_value_formatted": "1.000.000 đ",
    "created_at": "2026-01-23 10:30:00",
    "created_at_formatted": "23/01/2026 10:30",
    "completed_at": "2026-01-23 10:35:00",
    "items": [
      {
        "id": 1,
        "variant_id": 123,
        "variant": {
          "id": 123,
          "sku": "SKU-001",
          "product": {
            "id": 45,
            "name": "Sản phẩm A"
          },
          "option1_value": "Size M"
        },
        "quantity": 10,
        "quantity_requested": 10,
        "unit_price": 100000,
        "total_price": 1000000,
        "stock_before": 50,
        "stock_after": 60
      }
    ],
    "can_edit": false,
    "can_void": true,
    "public_url": "https://domain.com/receipt/PN260123ABCD"
  }
}
```

**Trạng thái:** Hoàn thành

---

### 3. Create Receipt

**Endpoint:** `POST /admin/api/v2/warehouse/accounting/receipts`

**Mục tiêu:** Tạo phiếu nhập/xuất kho mới

**Tham số Body:**
```json
{
  "type": "import",
  "receipt_code": "PN260123ABCD",
  "to_warehouse_id": 1,
  "from_warehouse_id": null,
  "supplier_name": "Công ty ABC",
  "supplier_phone": "0123456789",
  "supplier_address": "123 Đường ABC",
  "supplier_tax_id": "0123456789",
  "subject": "Nhập hàng tháng 1",
  "vat_invoice": "VAT001",
  "items": [
    {
      "variant_id": 123,
      "quantity": 10,
      "quantity_requested": 10,
      "unit_price": 100000,
      "total_price": 1000000,
      "batch_number": "BATCH001",
      "serial_number": null,
      "condition": "new"
    }
  ]
}
```

**Validation Rules:**
- `type`: required, in:import,export
- `receipt_code`: nullable, unique:stock_receipts,receipt_code
- `items`: required, array, min:1
- `items.*.variant_id`: required, exists:variants,id
- `items.*.quantity`: required, numeric, min:0.01
- `items.*.unit_price`: required, numeric, min:0

**Phản hồi mẫu (201):**
```json
{
  "success": true,
  "message": "Tạo phiếu thành công",
  "data": {
    "id": 1,
    "receipt_code": "PN260123ABCD",
    "type": "import",
    "status": "draft",
    "total_value": 1000000
  }
}
```

**Trạng thái:** Hoàn thành

---

### 4. Update Receipt

**Endpoint:** `PUT /admin/api/v2/warehouse/accounting/receipts/{id}`

**Mục tiêu:** Cập nhật phiếu (chỉ khi status = draft hoặc pending)

**Tham số URL:**
- `id` (required): ID của phiếu

**Tham số Body:** Tương tự Create Receipt (tất cả optional)

**Phản hồi mẫu (200):**
```json
{
  "success": true,
  "message": "Cập nhật phiếu thành công",
  "data": { ... }
}
```

**Phản hồi lỗi (403):**
```json
{
  "success": false,
  "message": "Phiếu đã hoàn thành, không thể chỉnh sửa"
}
```

**Trạng thái:** Hoàn thành

---

### 5. Complete Receipt

**Endpoint:** `POST /admin/api/v2/warehouse/accounting/receipts/{id}/complete`

**Mục tiêu:** Hoàn thành phiếu và cập nhật tồn kho

**Tham số URL:**
- `id` (required): ID của phiếu

**Phản hồi mẫu (200):**
```json
{
  "success": true,
  "message": "Hoàn thành phiếu thành công",
  "data": {
    "id": 1,
    "status": "completed",
    "completed_at": "2026-01-23 10:35:00"
  }
}
```

**Trạng thái:** Hoàn thành

---

### 6. Void Receipt

**Endpoint:** `POST /admin/api/v2/warehouse/accounting/receipts/{id}/void`

**Mục tiêu:** Hủy phiếu đã hoàn thành và hoàn kho

**Tham số URL:**
- `id` (required): ID của phiếu

**Tham số Body:**
```json
{
  "reason": "Hủy do lỗi nhập liệu"
}
```

**Phản hồi mẫu (200):**
```json
{
  "success": true,
  "message": "Hủy phiếu thành công",
  "data": {
    "id": 1,
    "status": "cancelled",
    "cancelled_at": "2026-01-23 11:00:00"
  }
}
```

**Trạng thái:** Hoàn thành

---

### 7. Get Statistics

**Endpoint:** `GET /admin/api/v2/warehouse/accounting/statistics`

**Mục tiêu:** Lấy thống kê phiếu nhập/xuất

**Tham số Query:**
- `type` (optional): `import` hoặc `export`
- `date_from` (optional): Ngày bắt đầu (format: Y-m-d)
- `date_to` (optional): Ngày kết thúc (format: Y-m-d)

**Phản hồi mẫu (200):**
```json
{
  "success": true,
  "data": {
    "total_receipts": 150,
    "total_value": 50000000,
    "import_count": 80,
    "export_count": 70
  }
}
```

**Trạng thái:** Hoàn thành

---

## Order Auto Export Receipt Integration

### Overview
Tính năng tự động tạo phiếu xuất kho khi đơn hàng được tạo và tự động cập nhật/hủy phiếu khi đơn hàng thay đổi trạng thái.

**Service:** `App\Services\Warehouse\OrderStockReceiptService`

---

### Logic Tự Động

#### 1. Tạo Đơn Hàng (Order Creation)

**Khi nào:** Khi đơn hàng được tạo với `status = '0'` (chờ xác nhận)

**Hành động:**
- Tự động tạo phiếu xuất kho (`type = 'export'`)
- Phiếu xuất kho được tạo với `status = 'completed'` (hoàn thành)
- Gán `subject = 'Đơn hàng {order_id}'`
- Gán `reference_type = 'order'`, `reference_id = {order_id}`, `reference_code = {order_code}`
- Lấy thông tin sản phẩm từ `OrderDetail` và tạo các dòng phiếu tương ứng
- Tự động cập nhật tồn kho (trừ kho)

**Vị trí tích hợp:**
- `app/Services/Cart/CartService.php` - Method `checkout()`

**Code Example:**
```php
// Auto create export receipt for order (status = '0' means chờ xác nhận -> receipt status = completed)
$orderStockReceiptService = app(\App\Services\Warehouse\OrderStockReceiptService::class);
$orderStockReceiptService->createExportReceiptFromOrder($order, \App\Models\StockReceipt::STATUS_COMPLETED);
```

---

#### 2. Cập Nhật Trạng Thái Đơn Hàng (Order Status Update)

**Khi nào:** Khi đơn hàng thay đổi trạng thái

**Logic:**

**a) Đơn hàng chuyển sang "Chờ xác nhận" (status = '0'):**
- Nếu chưa có phiếu xuất kho: Tạo mới với `status = 'completed'`
- Nếu đã có phiếu nhưng chưa completed: Hoàn thành phiếu (`status = 'completed'`)

**b) Đơn hàng chuyển sang "Đã hủy" (status = '2' hoặc '4'):**
- Tự động hủy phiếu xuất kho (gọi `voidReceipt()`)
- Xóa phiếu xuất kho (soft delete)
- Tự động hoàn kho (cộng lại số lượng đã trừ)

**Vị trí tích hợp:**
- `app/Modules/Order/Controllers/OrderController.php` - Method `postUpdate()`

**Code Example:**
```php
// Auto create/update export receipt based on order status
$orderStockReceiptService = app(\App\Services\Warehouse\OrderStockReceiptService::class);
$orderStockReceiptService->updateExportReceiptFromOrderStatus($order, (string)$oldStatus, (string)$newStatus);
```

---

### Service Methods

#### `createExportReceiptFromOrder(Order $order, string $status = 'completed'): ?StockReceipt`

Tạo phiếu xuất kho từ đơn hàng.

**Parameters:**
- `$order`: Order model instance
- `$status`: Receipt status (default: 'completed')

**Returns:**
- `StockReceipt` instance hoặc `null` nếu lỗi

**Logic:**
- Kiểm tra xem đã có phiếu cho đơn hàng này chưa (theo `reference_type = 'order'` và `reference_id`)
- Nếu đã có, trả về phiếu hiện tại
- Lấy danh sách `OrderDetail` và tạo các dòng phiếu
- Tự động tính tổng giá trị
- Nếu `status = 'completed'`, tự động hoàn thành phiếu và cập nhật tồn kho

---

#### `cancelExportReceiptFromOrder(Order $order, bool $delete = false): bool`

Hủy hoặc xóa phiếu xuất kho khi đơn hàng bị hủy.

**Parameters:**
- `$order`: Order model instance
- `$delete`: Nếu `true`, xóa phiếu; nếu `false`, chỉ đánh dấu cancelled

**Returns:**
- `bool`: `true` nếu thành công, `false` nếu lỗi

**Logic:**
- Tìm phiếu xuất kho theo `reference_type = 'order'` và `reference_id`
- Gọi `voidReceipt()` để hoàn kho (reverse stock)
- Nếu `$delete = true`, xóa phiếu (soft delete)
- Nếu `$delete = false`, chỉ đánh dấu `status = 'cancelled'`

---

#### `updateExportReceiptFromOrderStatus(Order $order, string $oldStatus, string $newStatus): bool`

Cập nhật phiếu xuất kho dựa trên thay đổi trạng thái đơn hàng.

**Parameters:**
- `$order`: Order model instance
- `$oldStatus`: Trạng thái cũ của đơn hàng
- `$newStatus`: Trạng thái mới của đơn hàng

**Returns:**
- `bool`: `true` nếu thành công, `false` nếu lỗi

**Logic:**
- Nếu `$newStatus = '0'` và chưa có phiếu: Tạo mới với `status = 'completed'`
- Nếu `$newStatus = '2'` hoặc `'4'`: Hủy và xóa phiếu
- Nếu `$newStatus = '0'` và phiếu chưa completed: Hoàn thành phiếu

---

### Mapping Trạng Thái

| Đơn Hàng Status | Ý Nghĩa | Phiếu Xuất Kho Status | Hành Động |
|----------------|---------|----------------------|-----------|
| `'0'` | Chờ xác nhận | `'completed'` | Tạo phiếu mới hoặc hoàn thành phiếu hiện có |
| `'1'` | Đã xác nhận | `'completed'` | Giữ nguyên (phiếu đã completed) |
| `'2'` | Đã hủy | `'cancelled'` hoặc xóa | Hủy phiếu và hoàn kho |
| `'4'` | Đã hủy | `'cancelled'` hoặc xóa | Hủy phiếu và hoàn kho |

---

### Database Fields

**stock_receipts table:**
- `reference_type`: `'order'` (khi được tạo từ đơn hàng)
- `reference_id`: ID của đơn hàng
- `reference_code`: Mã đơn hàng (`order.code`)
- `subject`: `'Đơn hàng {order_id}'`
- `customer_name`: Tên khách hàng từ đơn hàng
- `customer_id`: `order.member_id` (nếu có)

---

### Error Handling

- Tất cả lỗi được log vào Laravel log
- Lỗi không làm gián đoạn quá trình tạo/cập nhật đơn hàng
- Nếu tạo phiếu thất bại, đơn hàng vẫn được tạo thành công (graceful degradation)

---

### Files Created/Modified

**Created:**
- `app/Services/Warehouse/OrderStockReceiptService.php` - Service xử lý logic tự động tạo/cập nhật phiếu

**Modified:**
- `app/Services/Cart/CartService.php` - Tích hợp tạo phiếu khi tạo đơn hàng
- `app/Modules/Order/Controllers/OrderController.php` - Tích hợp cập nhật phiếu khi thay đổi trạng thái
- `app/Providers/AppServiceProvider.php` - Đăng ký OrderStockReceiptService

---

**Trạng thái:** Hoàn thành

---

**最后更新:** 2026-01-23
**维护者:** AI Assistant

---

## Cart & Checkout V2 API

### Overview
Cart và Checkout V2 được xây dựng lại từ đầu với kiến trúc sạch, tích hợp đầy đủ voucher (Promotion) và vận chuyển (GHTK/Delivery).

**Controllers:**
- `App\Themes\Website\Controllers\CartControllerV2` - Xử lý giỏ hàng
- `App\Themes\Website\Controllers\CheckoutControllerV2` - Xử lý thanh toán

**Views:**
- `app/Themes/Website/Views/cart/v2/index.blade.php` - Trang giỏ hàng
- `app/Themes/Website/Views/cart/v2/checkout.blade.php` - Trang thanh toán
- `app/Themes/Website/Views/cart/v2/result.blade.php` - Trang kết quả đặt hàng

---

### 1. GET /cart/gio-hang

**Mục tiêu:** Hiển thị trang giỏ hàng V2

**Phản hồi:** View với dữ liệu giỏ hàng từ CartService

**Trạng thái:** Hoàn thành

---

### 2. GET /cart/gio-hang.json

**Mục tiêu:** Lấy dữ liệu giỏ hàng dạng JSON

**Phản hồi mẫu (200):**
```json
{
  "success": true,
  "data": {
    "items": [
      {
        "variant_id": 123,
        "product_id": 10,
        "product_name": "Sản phẩm A",
        "variant_name": "Màu đỏ - Size M",
        "quantity": 2,
        "unit_price": 100000,
        "subtotal": 200000,
        "image": "https://cdn/..."
      }
    ],
    "summary": {
      "total_qty": 2,
      "subtotal": 200000,
      "discount": 0,
      "shipping_fee": 0,
      "total": 200000
    }
  }
}
```

**Trạng thái:** Hoàn thành

---

### 3. POST /cart/items

**Mục tiêu:** Thêm sản phẩm vào giỏ hàng

**Body (JSON):**
- `variant_id` (int, required): ID variant
- `qty` (int, required, min:1): Số lượng
- `is_deal` (bool, optional): Có phải Deal Sốc không

**Phản hồi mẫu (201):**
```json
{
  "success": true,
  "message": "Thêm vào giỏ hàng thành công",
  "data": {
    "total_qty": 3
  }
}
```

**Trạng thái:** Hoàn thành

---

### 4. PUT /cart/items/{variant_id}

**Mục tiêu:** Cập nhật số lượng sản phẩm trong giỏ hàng

**Body (JSON):**
- `qty` (int, required, min:0): Số lượng mới

**Phản hồi mẫu (200):**
```json
{
  "success": true,
  "data": {
    "summary": {
      "total_qty": 2,
      "subtotal": 200000
    }
  }
}
```

**Trạng thái:** Hoàn thành

---

### 5. DELETE /cart/items/{variant_id}

**Mục tiêu:** Xóa sản phẩm khỏi giỏ hàng

**Phản hồi mẫu (200):**
```json
{
  "success": true,
  "message": "Xóa sản phẩm thành công",
  "data": {
    "removed_variant_ids": [123],
    "summary": {
      "total_qty": 1,
      "subtotal": 100000
    }
  }
}
```

**Trạng thái:** Hoàn thành

---

### 6. GET /checkout/thanh-toan

**Mục tiêu:** Hiển thị trang thanh toán V2

**Phản hồi:** View với dữ liệu giỏ hàng, địa chỉ, danh sách promotion

**Trạng thái:** Hoàn thành

---

### 7. POST /checkout/thanh-toan

**Mục tiêu:** Xử lý đặt hàng

**Body (Form Data):**
- `token` (string, required): Security token
- `full_name` (string, required): Tên người mua
- `phone` (string, required): Số điện thoại
- `email` (string, optional): Email
- `address` (string, required): Địa chỉ chi tiết
- `province_id` (int, required): ID tỉnh/thành
- `district_id` (int, required): ID quận/huyện
- `ward_id` (int, required): ID phường/xã
- `remark` (string, optional): Ghi chú
- `shipping_fee` (float, optional): Phí vận chuyển

**Phản hồi mẫu (201):**
```json
{
  "success": true,
  "message": "Đặt hàng thành công",
  "data": {
    "order_id": 123,
    "order_code": "1234567890",
    "redirect_url": "/checkout/dat-hang-thanh-cong?code=1234567890"
  }
}
```

**Trạng thái:** Hoàn thành

---

### 8. POST /checkout/coupon/apply

**Mục tiêu:** Áp dụng mã giảm giá (voucher)

**Body (JSON):**
- `code` (string, required): Mã giảm giá

**Phản hồi mẫu (200):**
```json
{
  "success": true,
  "message": "Áp dụng mã thành công",
  "data": {
    "coupon": {
      "code": "GIAM10",
      "discount": 10000
    },
    "summary": {
      "subtotal": 200000,
      "discount": 10000,
      "total": 190000
    }
  }
}
```

**Trạng thái:** Hoàn thành

---

### 9. POST /checkout/coupon/remove

**Mục tiêu:** Hủy mã giảm giá

**Phản hồi mẫu (200):**
```json
{
  "success": true,
  "data": {
    "summary": {
      "subtotal": 200000,
      "discount": 0,
      "total": 200000
    }
  }
}
```

**Trạng thái:** Hoàn thành

---

### 10. POST /checkout/shipping-fee

**Mục tiêu:** Tính phí vận chuyển (GHTK)

**Body (JSON):**
- `province_id` (int, required): ID tỉnh/thành
- `district_id` (int, required): ID quận/huyện
- `ward_id` (int, required): ID phường/xã
- `address` (string, optional): Địa chỉ chi tiết

**Phản hồi mẫu (200):**
```json
{
  "success": true,
  "data": {
    "shipping_fee": 30000,
    "free_ship": false,
    "summary": {
      "subtotal": 200000,
      "discount": 0,
      "shipping_fee": 30000,
      "total": 230000
    }
  }
}
```

**Logic:**
- Kiểm tra free ship nếu tổng đơn >= `free_order` config
- Gọi GHTK API để tính phí vận chuyển nếu `ghtk_status = 1`
- Trả về phí vận chuyển và tổng đơn hàng đã cập nhật

**Trạng thái:** Hoàn thành

---

### 11. GET /checkout/search-location

**Mục tiêu:** Tìm kiếm địa chỉ (Xã, Huyện, Tỉnh)

**Query Params:**
- `q` (string, required): Từ khóa tìm kiếm

**Phản hồi mẫu (200):**
```json
{
  "results": [
    {
      "id": 123,
      "text": "Phường 1, Quận 1, TP. Hồ Chí Minh",
      "ward_id": 123,
      "ward_name": "Phường 1",
      "district_id": 456,
      "district_name": "Quận 1",
      "province_id": 789,
      "province_name": "TP. Hồ Chí Minh"
    }
  ]
}
```

**Trạng thái:** Hoàn thành

---

### 12. GET /checkout/dat-hang-thanh-cong

**Mục tiêu:** Hiển thị trang kết quả đặt hàng thành công

**Query Params:**
- `code` (string, required): Mã đơn hàng

**Phản hồi:** View với thông tin đơn hàng

**Trạng thái:** Hoàn thành

---

### Tích hợp Voucher (Promotion)

- Sử dụng model `App\Modules\Promotion\Models\Promotion`
- Validation: Kiểm tra `status = 1`, `start <= today`, `end >= today`, `order_sale <= subtotal`
- Áp dụng giảm giá: `unit = 0` (phần trăm) hoặc `unit = 1` (số tiền cố định)
- Lưu vào session: `ss_counpon` với `id`, `sale`, `code`, `value`, `unit`

---

### Tích hợp Vận chuyển (GHTK)

- Sử dụng service `CartService::calculateShippingFee()`
- Kiểm tra free ship: `free_ship = 1` và `subtotal >= free_order`
- Gọi GHTK API: `/services/shipment/fee` với thông tin pick address và delivery address
- Config: `ghtk_status`, `ghtk_url`, `ghtk_token` từ Config model

---

**最后更新:** 2026-01-25
**维护者:** AI Assistant
